<!doctype html>
<html lang="en">
<head>
    <title>Where Is COVID-19 in London?</title>
    <meta property="og:title" content="Where Is COVID-19 in London?" />
    <meta property="og:url" content="https://whereisitin.london" />
    <meta property="og:description" content="See where the latest cases of COVID-19 have been confirmed in London.">
    <meta property="og:image" content="https://pbs.twimg.com/media/ESl_gz1XYAEuGmE?format=jpg&name=4096x4096">
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="en_GB" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="leaflet/leaflet.js"></script>
    <script src="counties.js"></script>
    <script src="sparkline.js"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src="https://unpkg.com/random-points-generator"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
</head>
<body>
    <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="#">
            COVID-19 Cases in England
        </a>
      </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 col-lg-2 col-xl-2">
                <h5>Confirmed Cases</h5>
                <div class="totals" id="inner_london_total">
                    <svg class='sparkline' width='100' height='30' stroke-width='3'></svg>
                    <p class="total_number" >0</p>
                    <p class="total_location">Inner London</p>
                </div>
                <div class="totals" id="greater_london_total">
                    <svg class='sparkline' width='100' height='30' stroke-width='3'></svg>
                    <p class="total_number" >0</p>
                    <p class="total_location">Greater London</p class="total_location">
                </div>
                <div class="totals" id="england_total">
                    <svg class='sparkline' width='100' height='30' stroke-width='3'></svg>
                    <p class="total_number">0</p>
                    <p class="total_location">England</p class="total_location">
                </div>
            </div>
            <div class="col-lg col-xl col-md">
                <h5>Map of <select id="primaryMapVariable"><option value="populationRate">% of Population With COVID-19</option><option value="cases">Total Cases</option><option value="newCases">New Cases</option><option value="areaRate">Cases Per Square Kilometer</option></select></h5>
                <div id="primarymap"></div>
                <p><small>Data from <a href="https://www.gov.uk/government/publications/coronavirus-covid-19-number-of-cases-in-england/coronavirus-covid-19-number-of-cases-in-england">Public Health England</a>. Shows situation as of 2020-03-10 at 0900. New data released every afternoon / evening.</small></p>        
                <br />
                <!-- <h5>London Boroughs</h5>
                <select id="borough-picker"></select>
                <p><b><span id="borough_total">0</span></b> cases have been confirmed in <b><span id="borough_name">Hackney</span></b>.</p>
                <p>We don't have data about where exactly the cases are. Here is a simulation of what that number of cases might look like spread <em>randomly</em> across the borough.</p>
                <div id="localmap"></div> -->
            </div>
            <div class="col-md-3 col-lg-3 col-xl-3 ">

                <div class='box'>
                    <h5>Estimate Cases Nearby</h5>
                    <form id='estimationForm'>
                    <div class="input-group mb-3">
                        

                            <input type='text' class='form-control' placeholder='Enter Postcode Here' id='postcode' aria-describedby="get_estimate" />
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-outline-secondary" id='get_estimate'>Estimate</button>
                            </div>
                        
                    </div>
                    <div id='estimate'>

                    </div>
                </form>
                </div>

                <div class='box'>
                    <h5>New Cases in London</h5>
                    <table class="table" id="new_cases">
                        <thead>
                            <tr>
                            <th scope="col">Borough</th>
                            <th scope="col">New</th>
                            <th scope="col">Total</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
                
            </div>


        </div>
        </div>
        <footer class="footer">
            <div class="container-fluid">
              <span class="text-muted">whereisitin.london was built by <a href="http://brandonjackson.org">Brandon Jackson</a>. Feedback? Reach me on Twitter at <a href="https://twitter.com/glassboxed">@glassboxed</a>! </span>
            </div>
          </footer>
      
    <script>

        const today = "2020-03-10";
        const yesterday = "2020-03-09";

        const cases_archive = {
            "2020-03-05": {"Barking and Dagenham": 0,"Barnet": 3,"Barnsley": 2,"Bath and North East Somerset": 0,"Bedford": 0,"Bexley": 0,"Birmingham": 1,"Blackburn with Darwen": 0,"Blackpool": 0,"Bolton": 1,"Bournemouth, Christchurch and Poole": 0,"Bracknell Forest": 0,"Bradford": 1,"Brent": 0,"Brighton and Hove": 6,"Bristol, City of": 0,"Bromley": 1,"Buckinghamshire": 0,"Bury": 4,"Calderdale": 0,"Cambridgeshire": 0,"Camden": 2,"Central Bedfordshire": 0,"Cheshire East": 0,"Cheshire West and Chester": 0,"Cornwall and Isles of Scilly": 2,"County Durham": 0,"Coventry": 0,"Croydon": 0,"Cumbria": 0,"Darlington": 0,"Derby": 0,"Derbyshire": 3,"Devon": 7,"Doncaster": 0,"Dorset": 0,"Dudley": 0,"Ealing": 4,"East Riding of Yorkshire": 0,"East Sussex": 0,"Enfield": 0,"Essex": 3,"Gateshead": 0,"Gloucestershire": 3,"Greenwich": 0,"Hackney and City of London": 0,"Halton": 0,"Hammersmith and Fulham": 0,"Hampshire": 2,"Haringey": 0,"Harrow": 1,"Hartlepool": 0,"Havering": 0,"Herefordshire, County of": 0,"Hertfordshire": 5,"Hillingdon": 0,"Hounslow": 3,"Isle of Wight": 0,"Islington": 0,"Kensington and Chelsea": 4,"Kent": 2,"Kingston upon Hull, City of": 1,"Kingston upon Thames": 1,"Kirklees": 0,"Knowsley": 0,"Lambeth": 0,"Lancashire": 2,"Leeds": 3,"Leicester": 0,"Leicestershire": 0,"Lewisham": 2,"Lincolnshire": 1,"Liverpool": 0,"Luton": 0,"Manchester": 4,"Medway": 0,"Merton": 1,"Middlesbrough": 0,"Milton Keynes": 0,"Newcastle upon Tyne": 3,"Newham": 0,"Norfolk": 0,"North East Lincolnshire": 0,"North Lincolnshire": 0,"North Somerset": 0,"North Tyneside": 0,"North Yorkshire": 0,"Northamptonshire": 2,"Northumberland": 0,"Nottingham": 2,"Nottinghamshire": 0,"Oldham": 2,"Oxfordshire": 4,"Peterborough": 1,"Plymouth": 0,"Portsmouth": 0,"Reading": 0,"Redbridge": 0,"Redcar and Cleveland": 0,"Richmond upon Thames": 0,"Rochdale": 0,"Rotherham": 0,"Rutland": 0,"Salford": 0,"Sandwell": 0,"Sefton": 0,"Sheffield": 0,"Shropshire": 0,"Slough": 0,"Solihull": 0,"Somerset": 1,"South Gloucestershire": 0,"South Tyneside": 0,"Southampton": 0,"Southend-on-Sea": 0,"Southwark": 1,"St. Helens": 0,"Staffordshire": 4,"Stockport": 0,"Stockton-on-Tees": 0,"Stoke-on-Trent": 0,"Suffolk": 0,"Sunderland": 0,"Surrey": 4,"Sutton": 0,"Swindon": 0,"Tameside": 0,"Telford and Wrekin": 0,"Thurrock": 0,"Torbay": 4,"Tower Hamlets": 0,"Trafford": 4,"Wakefield": 0,"Walsall": 0,"Waltham Forest": 0,"Wandsworth": 2,"Warrington": 0,"Warwickshire": 0,"West Berkshire": 0,"West Sussex": 3,"Westminster": 0,"Wigan": 3,"Wiltshire": 3,"Windsor and Maidenhead": 0,"Wirral": 1,"Wokingham": 2,"Wolverhampton": 0,"Worcestershire": 0,"York": 3,"awaiting clarification": 8},
            "2020-03-07": {"Barking and Dagenham": 0,"Barnet": 3,"Barnsley": 2,"Bath and North East Somerset": 0,"Bedford": 0,"Bexley": 0,"Birmingham": 1,"Blackburn with Darwen": 0,"Blackpool": 0,"Bolton": 1,"Bournemouth, Christchurch and Poole": 0,"Bracknell Forest": 2,"Bradford": 1,"Brent": 1,"Brighton and Hove": 7,"Bristol, City of": 1,"Bromley": 1,"Buckinghamshire": 1,"Bury": 4,"Calderdale": 0,"Cambridgeshire": 0,"Camden": 2,"Central Bedfordshire": 0,"Cheshire East": 0,"Cheshire West and Chester": 0,"Cornwall and Isles of Scilly": 2,"County Durham": 0,"Coventry": 1,"Croydon": 0,"Cumbria": 4,"Darlington": 0,"Derby": 0,"Derbyshire": 3,"Devon": 10,"Doncaster": 0,"Dorset": 0,"Dudley": 0,"Ealing": 5,"East Riding of Yorkshire": 0,"East Sussex": 0,"Enfield": 0,"Essex": 3,"Gateshead": 0,"Gloucestershire": 3,"Greenwich": 0,"Hackney and City of London": 2,"Halton": 0,"Hammersmith and Fulham": 1,"Hampshire": 2,"Haringey": 0,"Harrow": 1,"Hartlepool": 0,"Havering": 0,"Herefordshire, County of": 0,"Hertfordshire": 8,"Hillingdon": 1,"Hounslow": 3,"Isle of Wight": 1,"Islington": 0,"Kensington and Chelsea": 6,"Kent": 2,"Kingston upon Hull, City of": 1,"Kingston upon Thames": 1,"Kirklees": 0,"Knowsley": 0,"Lambeth": 2,"Lancashire": 2,"Leeds": 3,"Leicester": 0,"Leicestershire": 1,"Lewisham": 2,"Lincolnshire": 1,"Liverpool": 3,"Luton": 2,"Manchester": 5,"Medway": 2,"Merton": 1,"Middlesbrough": 0,"Milton Keynes": 1,"Newcastle upon Tyne": 3,"Newham": 0,"Norfolk": 0,"North East Lincolnshire": 0,"North Lincolnshire": 0,"North Somerset": 0,"North Tyneside": 1,"North Yorkshire": 0,"Northamptonshire": 2,"Northumberland": 0,"Nottingham": 2,"Nottinghamshire": 3,"Oldham": 2,"Oxfordshire": 4,"Peterborough": 1,"Plymouth": 0,"Portsmouth": 0,"Reading": 0,"Redbridge": 1,"Redcar and Cleveland": 0,"Richmond upon Thames": 0,"Rochdale": 0,"Rotherham": 0,"Rutland": 0,"Salford": 0,"Sandwell": 0,"Sefton": 0,"Sheffield": 0,"Shropshire": 0,"Slough": 0,"Solihull": 0,"Somerset": 1,"South Gloucestershire": 0,"South Tyneside": 0,"Southampton": 0,"Southend-on-Sea": 1,"Southwark": 1,"St. Helens": 0,"Staffordshire": 4,"Stockport": 0,"Stockton-on-Tees": 0,"Stoke-on-Trent": 0,"Suffolk": 0,"Sunderland": 0,"Surrey": 4,"Sutton": 0,"Swindon": 1,"Tameside": 0,"Telford and Wrekin": 0,"Thurrock": 0,"Torbay": 4,"Tower Hamlets": 0,"Trafford": 4,"Wakefield": 0,"Walsall": 0,"Waltham Forest": 0,"Wandsworth": 2,"Warrington": 0,"Warwickshire": 0,"West Berkshire": 0,"West Sussex": 3,"Westminster": 2,"Wigan": 3,"Wiltshire": 3,"Windsor and Maidenhead": 0,"Wirral": 1,"Wokingham": 2,"Wolverhampton": 0,"Worcestershire": 0,"York": 3,"awaiting clarification": 14},
            "2020-03-08": {"Barking and Dagenham": 0,"Barnet": 4,"Barnsley": 2,"Bath and North East Somerset": 0,"Bedford": 0,"Bexley": 0,"Birmingham": 1,"Blackburn with Darwen": 0,"Blackpool": 0,"Bolton": 2,"Bournemouth, Christchurch and Poole": 2,"Bracknell Forest": 2,"Bradford": 1,"Brent": 3,"Brighton and Hove": 7,"Bristol, City of": 2,"Bromley": 1,"Buckinghamshire": 1,"Bury": 3,"Calderdale": 0,"Cambridgeshire": 0,"Camden": 2,"Central Bedfordshire": 0,"Cheshire East": 0,"Cheshire West and Chester": 0,"Cornwall and Isles of Scilly": 3,"County Durham": 0,"Coventry": 3,"Croydon": 0,"Cumbria": 5,"Darlington": 0,"Derby": 0,"Derbyshire": 4,"Devon": 12,"Doncaster": 0,"Dorset": 0,"Dudley": 0,"Ealing": 5,"East Riding of Yorkshire": 0,"East Sussex": 0,"Enfield": 0,"Essex": 5,"Gateshead": 0,"Gloucestershire": 3,"Greenwich": 0,"Hackney and City of London": 2,"Halton": 0,"Hammersmith and Fulham": 2,"Hampshire": 8,"Haringey": 0,"Harrow": 1,"Hartlepool": 0,"Havering": 0,"Herefordshire, County of": 0,"Hertfordshire": 13,"Hillingdon": 1,"Hounslow": 3,"Isle of Wight": 1,"Islington": 0,"Kensington and Chelsea": 8,"Kent": 4,"Kingston upon Hull, City of": 1,"Kingston upon Thames": 1,"Kirklees": 0,"Knowsley": 0,"Lambeth": 3,"Lancashire": 4,"Leeds": 3,"Leicester": 0,"Leicestershire": 1,"Lewisham": 3,"Lincolnshire": 1,"Liverpool": 4,"Luton": 2,"Manchester": 5,"Medway": 2,"Merton": 1,"Middlesbrough": 0,"Milton Keynes": 1,"Newcastle upon Tyne": 3,"Newham": 0,"Norfolk": 0,"North East Lincolnshire": 0,"North Lincolnshire": 0,"North Somerset": 0,"North Tyneside": 1,"North Yorkshire": 0,"Northamptonshire": 4,"Northumberland": 0,"Nottingham": 2,"Nottinghamshire": 3,"Oldham": 2,"Oxfordshire": 5,"Peterborough": 1,"Plymouth": 0,"Portsmouth": 0,"Reading": 0,"Redbridge": 1,"Redcar and Cleveland": 0,"Richmond upon Thames": 0,"Rochdale": 0,"Rotherham": 0,"Rutland": 0,"Salford": 0,"Sandwell": 0,"Sefton": 0,"Sheffield": 0,"Shropshire": 0,"Slough": 0,"Solihull": 0,"Somerset": 2,"South Gloucestershire": 0,"South Tyneside": 0,"Southampton": 0,"Southend-on-Sea": 1,"Southwark": 3,"St. Helens": 0,"Staffordshire": 4,"Stockport": 0,"Stockton-on-Tees": 0,"Stoke-on-Trent": 0,"Suffolk": 0,"Sunderland": 0,"Surrey": 5,"Sutton": 0,"Swindon": 2,"Tameside": 1,"Telford and Wrekin": 0,"Thurrock": 0,"Torbay": 6,"Tower Hamlets": 1,"Trafford": 4,"Wakefield": 0,"Walsall": 0,"Waltham Forest": 0,"Wandsworth": 3,"Warrington": 0,"Warwickshire": 3,"West Berkshire": 0,"West Sussex": 3,"Westminster": 3,"Wigan": 3,"Wiltshire": 3,"Windsor and Maidenhead": 0,"Wirral": 1,"Wokingham": 3,"Wolverhampton": 0,"Worcestershire": 0,"York": 3,"Awaiting confirmation": 20,},
            "2020-03-09": {"Barking and Dagenham": 0,"Barnet": 5,"Barnsley": 2,"Bath and North East Somerset": 0,"Bedford": 0,"Bexley": 0,"Birmingham": 1,"Blackburn with Darwen": 0,"Blackpool": 0,"Bolton": 3,"Bournemouth, Christchurch and Poole": 2,"Bracknell Forest": 2,"Bradford": 1,"Brent": 3,"Brighton and Hove": 8,"Bristol, City of": 2,"Bromley": 1,"Buckinghamshire": 1,"Bury": 3,"Calderdale": 0,"Cambridgeshire": 0,"Camden": 4,"Central Bedfordshire": 0,"Cheshire East": 0,"Cheshire West and Chester": 0,"Cornwall and Isles of Scilly": 4,"County Durham": 0,"Coventry": 2,"Croydon": 0,"Cumbria": 5,"Darlington": 0,"Derby": 0,"Derbyshire": 4,"Devon": 12,"Doncaster": 0,"Dorset": 0,"Dudley": 1,"Ealing": 5,"East Riding of Yorkshire": 0,"East Sussex": 0,"Enfield": 1,"Essex": 5,"Gateshead": 0,"Gloucestershire": 3,"Greenwich": 0,"Hackney and City of London": 2,"Halton": 0,"Hammersmith and Fulham": 2,"Hampshire": 8,"Haringey": 0,"Harrow": 1,"Hartlepool": 0,"Havering": 2,"Herefordshire, County of": 0,"Hertfordshire": 13,"Hillingdon": 1,"Hounslow": 3,"Isle of Wight": 1,"Islington": 0,"Kensington and Chelsea": 8,"Kent": 4,"Kingston upon Hull, City of": 1,"Kingston upon Thames": 1,"Kirklees": 0,"Knowsley": 0,"Lambeth": 3,"Lancashire": 4,"Leeds": 5,"Leicester": 0,"Leicestershire": 2,"Lewisham": 3,"Lincolnshire": 1,"Liverpool": 5,"Luton": 2,"Manchester": 5,"Medway": 2,"Merton": 1,"Middlesbrough": 0,"Milton Keynes": 1,"Newcastle upon Tyne": 4,"Newham": 0,"Norfolk": 0,"North East Lincolnshire": 0,"North Lincolnshire": 0,"North Somerset": 0,"North Tyneside": 1,"North Yorkshire": 0,"Northamptonshire": 4,"Northumberland": 0,"Nottingham": 2,"Nottinghamshire": 5,"Oldham": 4,"Oxfordshire": 5,"Peterborough": 1,"Plymouth": 0,"Portsmouth": 0,"Reading": 0,"Redbridge": 1,"Redcar and Cleveland": 0,"Richmond upon Thames": 0,"Rochdale": 0,"Rotherham": 0,"Rutland": 0,"Salford": 0,"Sandwell": 0,"Sefton": 0,"Sheffield": 0,"Shropshire": 0,"Slough": 0,"Solihull": 0,"Somerset": 2,"South Gloucestershire": 0,"South Tyneside": 0,"Southampton": 0,"Southend-on-Sea": 1,"Southwark": 5,"St. Helens": 0,"Staffordshire": 4,"Stockport": 0,"Stockton-on-Tees": 0,"Stoke-on-Trent": 0,"Suffolk": 1,"Sunderland": 1,"Surrey": 6,"Sutton": 1,"Swindon": 2,"Tameside": 1,"Telford and Wrekin": 0,"Thurrock": 0,"Torbay": 7,"Tower Hamlets": 1,"Trafford": 4,"Wakefield": 0,"Walsall": 0,"Waltham Forest": 1,"Wandsworth": 3,"Warrington": 0,"Warwickshire": 4,"West Berkshire": 0,"West Sussex": 3,"Westminster": 3,"Wigan": 3,"Wiltshire": 3,"Windsor and Maidenhead": 0,"Wirral": 1,"Wokingham": 3,"Wolverhampton": 2,"Worcestershire": 0,"York": 3,"Awaiting confirmation": 26,},
            "2020-03-10": {"Barking and Dagenham": 1,"Barnet": 8,"Barnsley": 2,"Bath and North East Somerset": 0,"Bedford": 0,"Bexley": 0,"Birmingham": 1,"Blackburn with Darwen": 0,"Blackpool": 0,"Bolton": 3,"Bournemouth, Christchurch and Poole": 3,"Bracknell Forest": 2,"Bradford": 1,"Brent": 3,"Brighton and Hove": 8,"Bristol, City of": 2,"Bromley": 2,"Buckinghamshire": 2,"Bury": 3,"Calderdale": 0,"Cambridgeshire": 1,"Camden": 5,"Central Bedfordshire": 0,"Cheshire East": 0,"Cheshire West and Chester": 0,"Cornwall and Isles of Scilly": 4,"County Durham": 1,"Coventry": 3,"Croydon": 1,"Cumbria": 7,"Darlington": 0,"Derby": 0,"Derbyshire": 4,"Devon": 13,"Doncaster": 0,"Dorset": 0,"Dudley": 1,"Ealing": 5,"East Riding of Yorkshire": 0,"East Sussex": 0,"Enfield": 1,"Essex": 5,"Gateshead": 0,"Gloucestershire": 3,"Greenwich": 1,"Hackney and City of London": 3,"Halton": 0,"Hammersmith and Fulham": 2,"Hampshire": 10,"Haringey": 1,"Harrow": 1,"Hartlepool": 0,"Havering": 2,"Herefordshire, County of": 1,"Hertfordshire": 16,"Hillingdon": 1,"Hounslow": 5,"Isle of Wight": 1,"Islington": 1,"Kensington and Chelsea": 13,"Kent": 5,"Kingston upon Hull, City of": 1,"Kingston upon Thames": 1,"Kirklees": 0,"Knowsley": 0,"Lambeth": 4,"Lancashire": 4,"Leeds": 5,"Leicester": 0,"Leicestershire": 2,"Lewisham": 3,"Lincolnshire": 1,"Liverpool": 5,"Luton": 2,"Manchester": 5,"Medway": 2,"Merton": 2,"Middlesbrough": 0,"Milton Keynes": 2,"Newcastle upon Tyne": 4,"Newham": 0,"Norfolk": 0,"North East Lincolnshire": 0,"North Lincolnshire": 0,"North Somerset": 1,"North Tyneside": 1,"North Yorkshire": 0,"Northamptonshire": 5,"Northumberland": 0,"Nottingham": 2,"Nottinghamshire": 5,"Oldham": 4,"Oxfordshire": 7,"Peterborough": 1,"Plymouth": 0,"Portsmouth": 0,"Reading": 0,"Redbridge": 1,"Redcar and Cleveland": 0,"Richmond upon Thames": 1,"Rochdale": 0,"Rotherham": 1,"Rutland": 0,"Salford": 0,"Sandwell": 0,"Sefton": 0,"Sheffield": 0,"Shropshire": 1,"Slough": 1,"Solihull": 0,"Somerset": 2,"South Gloucestershire": 0,"South Tyneside": 0,"Southampton": 0,"Southend-on-Sea": 1,"Southwark": 8,"St. Helens": 0,"Staffordshire": 4,"Stockport": 0,"Stockton-on-Tees": 0,"Stoke-on-Trent": 0,"Suffolk": 1,"Sunderland": 1,"Surrey": 6,"Sutton": 2,"Swindon": 2,"Tameside": 1,"Telford and Wrekin": 0,"Thurrock": 0,"Torbay": 7,"Tower Hamlets": 4,"Trafford": 4,"Wakefield": 0,"Walsall": 0,"Waltham Forest": 1,"Wandsworth": 3,"Warrington": 0,"Warwickshire": 4,"West Berkshire": 0,"West Sussex": 3,"Westminster": 5,"Wigan": 3,"Wiltshire": 4,"Windsor and Maidenhead": 1,"Wirral": 1,"Wokingham": 3,"Wolverhampton": 3,"Worcestershire": 0,"York": 3,"Awaiting confirmation": 15,}
        }

        // Population Data Source:
        // https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/populationestimatesforukenglandandwalesscotlandandnorthernireland
        const place_data = {
            "Barking and Dagenham": { "population": 211998, "area": 36, "type": "Greater London" },
            "Barnet": { "population": 392140, "area": 87, "type": "Greater London" },
            "Barnsley": { "population": 245199, "area": 328, "type": "Metropolitan District" },
            "Bath and North East Somerset": { "population": 192106, "area": 350, "type": "Unitary Authority" },
            "Bedford": { "population": 171623, "area": 475, "type": "Unitary Authority" },
            "Bexley": { "population": 247258, "area": 61, "type": "Greater London" },
            "Birmingham": { "population": 1141374, "area": 267, "type": "Metropolitan District" },
            "Blackburn with Darwen": { "population": 148942, "area": 137, "type": "Unitary Authority" },
            "Blackpool": { "population": 139305, "area": 35, "type": "Unitary Authority" },
            "Bolton": { "population": 285372, "area": 140, "type": "Metropolitan District" },
            "Bournemouth, Christchurch and Poole": { "population": 395784, "area": 111, "type": "Unitary Authority" },
            "Bracknell Forest": { "population": 121676, "area": 109, "type": "Unitary Authority" },
            "Bradford": { "population": 537173, "area": 367, "type": "Metropolitan District" },
            "Brent": { "population": 330795, "area": 43, "type": "Greater London" },
            "Brighton and Hove": { "population": 290395, "area": 83, "type": "Unitary Authority" },
            "Bristol, City of": { "population": 463405, "area": 110, "type": "Unitary Authority" },
            "Bromley": { "population": 331096, "area": 150, "type": "Greater London" },
            "Buckinghamshire": { "population": 540059, "area": 1564, "type": "County" },
            "Bury": { "population": 190108, "area": 100, "type": "Metropolitan District" },
            "Calderdale": { "population": 210082, "area": 363, "type": "Metropolitan District" },
            "Cambridgeshire": { "population": 651482, "area": 3052, "type": "County" },
            "Camden": { "population": 262226, "area": 21, "type": "Inner London" },
            "Central Bedfordshire": { "population": 283606, "area": 715, "type": "Unitary Authority" },
            "Cheshire East": { "population": 380790, "area": 1167, "type": "Unitary Authority" },
            "Cheshire West and Chester": { "population": 340502, "area": 913, "type": "Unitary Authority" },
            "Cornwall and Isles of Scilly": { "population": 565968, "area": 3562, "type": "Unitary Authority" },
            "County Durham": { "population": 526980, "area": 2229, "type": "Unitary Authority" },
            "Coventry": { "population": 366785, "area": 98, "type": "Metropolitan District" },
            "Croydon": { "population": 385346, "area": 87, "type": "Greater London" },
            "Cumbria": { "population": 498888, "area": 6810, "type": "County" },
            "Darlington": { "population": 106566, "area": 197, "type": "Unitary Authority" },
            "Derby": { "population": 257174, "area": 79, "type": "Unitary Authority" },
            "Derbyshire": { "population": 796142, "area": 2547, "type": "County" },
            "Devon": { "population": 795286, "area": 6560, "type": "County" },
            "Doncaster": { "population": 310542, "area": 568, "type": "Metropolitan District" },
            "Dorset": { "population": 376484, "area": 2543, "type": "Unitary Authority" },
            "Dudley": { "population": 320626, "area": 97, "type": "Metropolitan District" },
            "Ealing": { "population": 341982, "area": 55, "type": "Greater London" },
            "East Riding of Yorkshire": { "population": 339614, "area": 2403, "type": "Unitary Authority" },
            "East Sussex": { "population": 554590, "area": 1713, "type": "County" },
            "Enfield": { "population": 333869, "area": 82, "type": "Greater London" },
            "Essex": { "population": 1477764, "area": 3462, "type": "County" },
            "Gateshead": { "population": 202508, "area": 143, "type": "Metropolitan District" },
            "Gloucestershire": { "population": 633558, "area": 2651, "type": "County" },
            "Greenwich": { "population": 286186, "area": 47, "type": "Inner London" },
            "Hackney and City of London": { "population": 288371, "area": 22, "type": "Inner London" },
            "Halton": { "population": 128432, "area": 79, "type": "Unitary Authority" },
            "Hammersmith and Fulham": { "population": 185426, "area": 17, "type": "Inner London" },
            "Hampshire": { "population": 1376316, "area": 3678, "type": "County" },
            "Haringey": { "population": 270624, "area": 30, "type": "Greater London" },
            "Harrow": { "population": 250149, "area": 50, "type": "Greater London" },
            "Hartlepool": { "population": 93242, "area": 94, "type": "Unitary Authority" },
            "Havering": { "population": 257810, "area": 112, "type": "Greater London" },
            "Herefordshire, County of": { "population": 192107, "area": 2178, "type": "Unitary Authority" },
            "Hertfordshire": { "population": 1184365, "area": 1643, "type": "County" },
            "Hillingdon": { "population": 304824, "area": 116, "type": "Greater London" },
            "Hounslow": { "population": 270782, "area": 57, "type": "Greater London" },
            "Isle of Wight": { "population": 141538, "area": 380, "type": "Unitary Authority" },
            "Islington": { "population": 239142, "area": 15, "type": "Inner London" },
            "Kensington and Chelsea": { "population": 156197, "area": 12, "type": "Inner London" },
            "Kent": { "population": 1568623, "area": 3736, "type": "County" },
            "Kingston upon Hull, City of": { "population": 260645, "area": 71, "type": "Unitary Authority" },
            "Kingston upon Thames": { "population": 175470, "area": 37, "type": "Greater London" },
            "Kirklees": { "population": 438727, "area": 408, "type": "Metropolitan District" },
            "Knowsley": { "population": 149571, "area": 87, "type": "Metropolitan District" },
            "Lambeth": { "population": 325917, "area": 27, "type": "Inner London" },
            "Lancashire": { "population": 1210053, "area": 2896, "type": "County" },
            "Leeds": { "population": 789194, "area": 551, "type": "Metropolitan District" },
            "Leicester": { "population": 355218, "area": 73, "type": "Unitary Authority" },
            "Leicestershire": { "population": 698268, "area": 2081, "type": "County" },
            "Lewisham": { "population": 303536, "area": 35, "type": "Inner London" },
            "Lincolnshire": { "population": 755833, "area": 5928, "type": "County" },
            "Liverpool": { "population": 494814, "area": 111, "type": "Metropolitan District" },
            "Luton": { "population": 214109, "area": 44, "type": "Unitary Authority" },
            "Manchester": { "population": 547627, "area": 116, "type": "Metropolitan District" },
            "Medway": { "population": 277855, "area": 194, "type": "Unitary Authority" },
            "Merton": { "population": 206186, "area": 37, "type": "Greater London" },
            "Middlesbrough": { "population": 140545, "area": 54, "type": "Unitary Authority" },
            "Milton Keynes": { "population": 268607, "area": 308, "type": "Unitary Authority" },
            "Newcastle upon Tyne": { "population": 300196, "area": 114, "type": "Metropolitan District" },
            "Newham": { "population": 352005, "area": 36, "type": "Greater London" },
            "Norfolk": { "population": 903680, "area": 5371, "type": "County" },
            "North East Lincolnshire": { "population": 159821, "area": 191, "type": "Unitary Authority" },
            "North Lincolnshire": { "population": 172005, "area": 846, "type": "Unitary Authority" },
            "North Somerset": { "population": 213919, "area": 374, "type": "Unitary Authority" },
            "North Tyneside": { "population": 205985, "area": 82, "type": "Metropolitan District" },
            "North Yorkshire": { "population": 614505, "area": 8654, "type": "County" },
            "Northamptonshire": { "population": 747622, "area": 2365, "type": "County" },
            "Northumberland": { "population": 320274, "area": 5019, "type": "Unitary Authority" },
            "Nottingham": { "population": 331069, "area": 75, "type": "Unitary Authority" },
            "Nottinghamshire": { "population": 823126, "area": 2084, "type": "County" },
            "Oldham": { "population": 235623, "area": 142, "type": "Metropolitan District" },
            "Oxfordshire": { "population": 687524, "area": 2604, "type": "County" },
            "Peterborough": { "population": 201041, "area": 344, "type": "Unitary Authority" },
            "Plymouth": { "population": 263100, "area": 80, "type": "Unitary Authority" },
            "Portsmouth": { "population": 215133, "area": 41, "type": "Unitary Authority" },
            "Reading": { "population": 163203, "area": 40, "type": "Unitary Authority" },
            "Redbridge": { "population": 303858, "area": 56, "type": "Greater London" },
            "Redcar and Cleveland": { "population": 136718, "area": 244, "type": "Unitary Authority" },
            "Richmond upon Thames": { "population": 196904, "area": 58, "type": "Greater London" },
            "Rochdale": { "population": 220001, "area": 158, "type": "Metropolitan District" },
            "Rotherham": { "population": 264671, "area": 287, "type": "Metropolitan District" },
            "Rutland": { "population": 39697, "area": 394, "type": "Unitary Authority" },
            "Salford": { "population": 254408, "area": 97, "type": "Metropolitan District" },
            "Sandwell": { "population": 327378, "area": 85, "type": "Metropolitan District" },
            "Sefton": { "population": 275396, "area": 153, "type": "Metropolitan District" },
            "Sheffield": { "population": 582506, "area": 367, "type": "Metropolitan District" },
            "Shropshire": { "population": 320274, "area": 3193, "type": "Unitary Authority" },
            "Slough": { "population": 149112, "area": 32, "type": "Unitary Authority" },
            "Solihull": { "population": 214909, "area": 178, "type": "Metropolitan District" },
            "Somerset": { "population": 559399, "area": 3451, "type": "County" },
            "South Gloucestershire": { "population": 282644, "area": 496, "type": "Unitary Authority" },
            "South Tyneside": { "population": 150265, "area": 65, "type": "Metropolitan District" },
            "Southampton": { "population": 252796, "area": 50, "type": "Unitary Authority" },
            "Southend-on-Sea": { "population": 182463, "area": 42, "type": "Unitary Authority" },
            "Southwark": { "population": 317256, "area": 29, "type": "Inner London" },
            "St. Helens": { "population": 180049, "area": 135, "type": "Metropolitan District" },
            "Staffordshire": { "population": 875219, "area": 2623, "type": "County" },
            "Stockport": { "population": 291775, "area": 126, "type": "Metropolitan District" },
            "Stockton-on-Tees": { "population": 197213, "area": 204, "type": "Unitary Authority" },
            "Stoke-on-Trent": { "population": 255833, "area": 93, "type": "Unitary Authority" },
            "Suffolk": { "population": 758556, "area": 3794, "type": "County" },
            "Sunderland": { "population": 277417, "area": 138, "type": "Metropolitan District" },
            "Surrey": { "population": 1189934, "area": 1669, "type": "County" },
            "Sutton": { "population": 204525, "area": 44, "type": "Greater London" },
            "Swindon": { "population": 221996, "area": 230, "type": "Unitary Authority" },
            "Tameside": { "population": 225197, "area": 103, "type": "Metropolitan District" },
            "Telford and Wrekin": { "population": 177799, "area": 289, "type": "Unitary Authority" },
            "Thurrock": { "population": 172525, "area": 162, "type": "Unitary Authority" },
            "Torbay": { "population": 135780, "area": 63, "type": "Unitary Authority" },
            "Tower Hamlets": { "population": 317705, "area": 20, "type": "Inner London" },
            "Trafford": { "population": 236370, "area": 106, "type": "Metropolitan District" },
            "Wakefield": { "population": 345038, "area": 339, "type": "Metropolitan District" },
            "Walsall": { "population": 283378, "area": 105, "type": "Metropolitan District" },
            "Waltham Forest": { "population": 276700, "area": 39, "type": "Greater London" },
            "Wandsworth": { "population": 326474, "area": 35, "type": "Inner London" },
            "Warrington": { "population": 209547, "area": 181, "type": "Unitary Authority" },
            "Warwickshire": { "population": 571010, "area": 1975, "type": "County" },
            "West Berkshire": { "population": 158527, "area": 702, "type": "Unitary Authority" },
            "West Sussex": { "population": 858852, "area": 1991, "type": "County" },
            "Westminster": { "population": 255324, "area": 22, "type": "Inner London" },
            "Wigan": { "population": 326088, "area": 187, "type": "Metropolitan District" },
            "Wiltshire": { "population": 498064, "area": 3253, "type": "Unitary Authority" },
            "Windsor and Maidenhead": { "population": 150906, "area": 197, "type": "Unitary Authority" },
            "Wirral": { "population": 323235, "area": 158, "type": "Metropolitan District" },
            "Wokingham": { "population": 167979, "area": 180, "type": "Unitary Authority" },
            "Wolverhampton": { "population": 262008, "area": 69, "type": "Metropolitan District" },
            "Worcestershire": { "population": 592057, "area": 1740, "type": "County" },
            "York": { "population": 209893, "area": 272, "type": "Unitary Authority" },
        }

        function generateData(cases){
            let data = {};
            const dates = Object.keys(cases);
            const yesterday = dates[dates.length - 2];
            const today = dates[dates.length - 1];
            for(const place in place_data){
                let region = {}

                // Place Basics
                region.name = place;
                region.population = place_data[place].population;
                region.area = place_data[place].area;
                region.type = place_data[place].type;

                // Case Data
                region.cases = cases[today][place];
                region.newCases = 0;
                if(cases[yesterday] != undefined){
                    region.newCases = region.cases - cases[yesterday][place];
                } else { 
                    region.newCases = region.cases;
                }
                region.caseSeries = [];
                case_list = Object.values(cases);
                for(var i = 0; i < case_list.length; i++){
                    region.caseSeries.push(case_list[i][place]);
                }

                // Stats
                region.populationRate = region.cases / region.population;
                region.areaRate = region.cases / region.area;

                // Save to the list
                data[place] = region;
            }
            return data;
        }
        let data = generateData(cases_archive);

        function setPrimaryMapData(data, variable){

            const breaks = {
                'cases': [0, 1, 2, 4, 8, 16, 32],
                'newCases': [0, 1, 2, 4, 8, 16, 32],
                'populationRate': [0, 0.00001, 0.00002, 0.00003, 0.00004, 0.00005, 0.00006],
                'areaRate': [0, 0.01, 0.1, 0.5, 1, 2, 3]
            }

            function calculateColor(number){
                return number > breaks[variable][6] ? '#800026' :
                    number > breaks[variable][5]  ? '#BD0026' :
                    number > breaks[variable][4]  ? '#E31A1C' :
                    number > breaks[variable][3]  ? '#FC4E2A' :
                    number > breaks[variable][2]   ? '#FD8D3C' :
                    number > breaks[variable][1]   ? '#FEB24C' :
                    number > breaks[variable][0]   ? '#FED976' :
                                    '#FFFFFF';
            }
            
            primaryMapGeoJSON.setStyle(function(feature){
                return {
                    fillColor: calculateColor(data[feature.properties.ctyua15nm][variable]),
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '',
                    fillOpacity: 0.7
                }
            });

            let legend = document.querySelector('.legend');
            legend.innerHTML = "";
            labels = [];
        
            // loop through our density intervals and generate a label with a colored square for each interval
            for (var i = 0; i < breaks[variable].length; i++) {

                if(variable=="populationRate"){
                    legend.innerHTML +=
                    '<i style="background:' + (calculateColor(breaks[variable][i]*1.000001)) + '"></i> ' +
                    breaks[variable][i]*100 +'%' + (breaks[variable][i + 1] ? '<br>' : '+');
                } else if(variable == "areaRate"){
                    legend.innerHTML +=
                        '<i style="background:' + calculateColor(breaks[variable][i]) + '"></i> ' +
                        breaks[variable][i] + (breaks[variable][i + 1] ? '&ndash;' + (breaks[variable][i + 1]*0.99) + '<br>' : '+');

                } else if(variable=="cases" || variable == "newCases"){
                    // used for generating ranges...we just need the single values right now
                    legend.innerHTML +=
                        '<i style="background:' + calculateColor(breaks[variable][i]) + '"></i> ' +
                        breaks[variable][i] + (breaks[variable][i + 1] ? '&ndash;' + (breaks[variable][i + 1] - 0.01) + '<br>' : '+');
                }

                    
            }
        }

        const inner_london = [
            "Camden",
            "Greenwich",
            "Hackney and City of London",
            "Hammersmith and Fulham",
            "Islington",
            "Kensington and Chelsea",
            "Lambeth",
            "Lewisham",
            "Southwark",
            "Tower Hamlets",
            "Wandsworth",
            "Westminster"
        ];

        const greater_london = [
            "Barking and Dagenham",
            "Barnet",
            "Brent",
            "Bromley",
            "Camden",
            "Croydon",
            "Ealing",
            "Enfield",
            "Greenwich",
            "Hackney and City of London",
            "Hammersmith and Fulham",
            "Haringey",
            "Harrow",
            "Havering",
            "Hillingdon",
            "Hounslow",
            "Islington",
            "Kensington and Chelsea",
            "Kingston upon Thames",
            "Lambeth",
            "Lewisham",
            "Merton",
            "Newham",
            "Redbridge",
            "Richmond upon Thames",
            "Southwark",
            "Sutton",
            "Tower Hamlets",
            "Waltham Forest",
            "Wandsworth",
            "Westminster",
        ];


        function getTotalCases(region, date){

            if(date==undefined){
                date = today;
            }
            let total = 0;
            let places = Object.keys(cases_archive[date]);
            let case_counts = Object.values(cases_archive[date]);
            for(var i = 0; i < case_counts.length; i++){
                if(region=="England" 
                    || region==undefined 
                    || (region=="Inner London" && inner_london.includes(places[i]))
                    || (region=="Greater London" && greater_london.includes(places[i]))){
                    
                    total += case_counts[i]
                }
            }
            return total;
        }

        let totals = {
            "England": { total: 0, series: [] },
            "Inner London": { total: 0, series: [] },
            "Greater London": { total: 0, series: [] },
        }

        function calculateAllTotals(){
            let places = Object.keys(totals);
            let dates = Object.keys(cases_archive);
            for(var i = 0; i < places.length; i++){
                totals[places[i]].total = getTotalCases(places[i]);
                for(var j = 0; j < dates.length; j++){
                    totals[places[i]].series.push(getTotalCases(places[i],dates[j]));
                }
            }
        }
        calculateAllTotals();


        var primarymap = L.map('primarymap').setView([51.505, -0.09], 10);
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: 'pk.eyJ1IjoiYnJhbmRvbmphY2tzb24iLCJhIjoiY2s3aTFuYXZwMGY0ODNubW45d24yMGUxMiJ9.ruZUCY7P0KzZYhzDU_aQRg'
        }).addTo(primarymap);

        function highlightFeature(e) {
            var layer = e.target;

            layer.setStyle({
                weight: 5,
                color: '#666',
                dashArray: '',
                fillOpacity: 0.7
            });

            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }

            info.update(layer.feature.properties);
        }

        function resetHighlight(e) {
            e.target.setStyle({
                weight: 2,
                color: '#FFF',
                dashArray: '',
                fillOpacity: 0.7
            });
            info.update();
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                click: highlightFeature,
                mouseout: resetHighlight
            });
        }

        let primaryMapGeoJSON = L.geoJson(counties, {
            style: function(feature) {
                return {
                    fillColor: '#FFF',
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '',
                    fillOpacity: 0.1
                };
            },
            onEachFeature: onEachFeature
        }).addTo(primarymap);

        // Info Box
        var info = L.control();
        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };
        info.update = function (props) {
            this._div.innerHTML = '';
            if(props){
                let region = data[props.ctyua15nm];
                this._div.innerHTML += '<h5>' + region.name + '</h5>';
                this._div.innerHTML += "<svg class='sparkline' width='100' height='30' stroke-width='3'></svg>";
                this._div.innerHTML += "<br/>" + region.cases + ' cases';
                if(region.newCases > 0){
                    this._div.innerHTML += "<span style='color: red;'> (▲" + region.newCases + ")</span>";
                }
                if(region.populationRate != undefined){
                    this._div.innerHTML += "<br/>" + (region.populationRate * 100).toFixed(4) + '% of population';
                }
                if(region.areaRate != undefined){
                    this._div.innerHTML += "<br/>" + region.areaRate.toFixed(3) + ' cases per square kilometer';
                }



                sparkline.sparkline(document.querySelector(".info .sparkline"), region.caseSeries);
            } else {
                this._div.innerHTML +='Hover over a region';
            }
        };
        info.addTo(primarymap);

        // Create Legend
        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            // add the rest of the stuff when we add data to the map
            return div;
        };
        legend.addTo(primarymap);

        setPrimaryMapData(data, "populationRate");

        document.querySelector('#primaryMapVariable').addEventListener('change', (event)=>{
            setPrimaryMapData(data, event.target.value)
        });

        function updateTotals(){
            document.querySelector("#inner_london_total .total_number").innerHTML = totals["Inner London"].total;
            sparkline.sparkline(document.querySelector("#inner_london_total .sparkline"), totals["Inner London"].series, { interactive: true });
            document.querySelector("#greater_london_total .total_number").innerHTML = totals["Greater London"].total;
            sparkline.sparkline(document.querySelector("#greater_london_total .sparkline"), totals["Greater London"].series, { interactive: true });
            document.querySelector("#england_total .total_number").innerHTML = totals["England"].total;
            sparkline.sparkline(document.querySelector("#england_total .sparkline"), totals["England"].series, { interactive: true });
        }

        function generateNewCasesTable(){
            var sortable = []
            for(var i = 0; i < greater_london.length; i++){
                let region = data[greater_london[i]];
                sortable.push([greater_london[i],region.newCases, region.cases]);
            }
            sortable.sort(function(a, b){
                return b[1] - a[1]
            });

            var table = document.getElementById("new_cases");
            for(var i = 0; i < sortable.length; i++){
                if(sortable[i][1] > 0){
                    var row = table.insertRow();
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    var cell3 = row.insertCell(2);
                    cell1.innerHTML = sortable[i][0];
                    cell2.innerHTML =  "▲ " + sortable[i][1];
                    cell3.innerHTML =  sortable[i][2];
                }
            }
        }

        updateTotals();
        generateNewCasesTable();


        // var localmap = L.map('localmap').setView([51.505, -0.09], 10);
        // L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        //     attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        //     maxZoom: 18,
        //     id: 'mapbox/streets-v11',
        //     tileSize: 512,
        //     zoomOffset: -1,
        //     accessToken: 'pk.eyJ1IjoiYnJhbmRvbmphY2tzb24iLCJhIjoiY2s3aTFuYXZwMGY0ODNubW45d24yMGUxMiJ9.ruZUCY7P0KzZYhzDU_aQRg'
        // }).addTo(localmap);

        // let local_geojson = L.geoJson({
        //     "type": "FeatureCollection",
        //     "features": []
        //     }, {}
        // );
        // local_geojson.addTo(localmap);


        // let picker = document.getElementById('borough-picker');
        // for(var i = 0; i < greater_london.length; i++){

        //     var borough = greater_london[i];
        //     // create new option element
        //     var opt = document.createElement('option');
        //     opt.appendChild(document.createTextNode(borough));
        //     opt.value = borough; 
        //     picker.appendChild(opt); 
        // }
        // picker.addEventListener('change', (event) => {
        //     updateLocalMap(event.target.value)
        // });
        // picker.selectedIndex = 17;
        // updateLocalMap(picker.value);

        // setInterval(()=>{
        //     updateLocalMap(picker.value);
        // }, 3000);


        function getBoroughGeoJSON(borough_name){
            var borough_geojson = null;
            for(var i = 0; i < counties.features.length; i++){
                if(counties.features[i].properties.ctyua15nm == borough_name){
                    borough_geojson = counties.features[i];
                    break;
                }
            }
            return borough_geojson;
        }


        // function updateLocalMap(borough){
            
        //     borough_geojson = getBoroughGeoJSON(borough);
        //     if(borough_geojson != null){
        //         bbox = turf.bbox(borough_geojson);
        //         let cases = cases_archive[today][borough];
        //         let points = generatePointsInBorough(cases, borough);
                
        //         local_geojson.clearLayers();
        //         local_geojson.addData(points);

        //         document.getElementById('borough_name').innerHTML = borough;
        //         document.getElementById('borough_total').innerHTML = cases;
                

        //         localmap.fitBounds([
        //             [bbox[1],bbox[0]],
        //             [bbox[3],bbox[2]]
        //         ])
        //     }
        // }

        function generatePointsInBorough(n, borough_name){
            let borough_geojson = getBoroughGeoJSON(borough_name);
            var bbox = turf.bbox(borough_geojson);
            var points = [];
            while(points.length < n){
                var point = turf.randomPoint(1, {bbox: bbox});
                if(turf.booleanPointInPolygon(point.features[0], borough_geojson)){
                    points.push(point.features[0]);
                }
            }
            return turf.featureCollection(points);
        }

        let form = document.querySelector('#estimationForm');
        form.addEventListener('submit', function(e){
            e.preventDefault();
            let postcode = document.querySelector("#postcode").value.replace(/\s/g,'');
            console.log(postcode);
            fetch('https://api.postcodes.io/postcodes/' + postcode)
                .then(response => {
                    console.log(response);
                    response.json().then(function(data) {
                        console.log(data.result.latitude)
                        console.log(data.result.longitude);
                        let nearby = calculateNearbyCases(data.result.latitude, data.result.longitude);
                        
                        let estimate = document.querySelector('#estimate');
                        estimate.innerHTML = "⚠️ Available data is not specific enough to make reliable predictions. Below is a <em>rough estimate</em> based on what we know: "
                        estimate.innerHTML += "<ul><li>Between " + (nearby.fiveminwalk / 3).toFixed(1) + " and " + nearby.fiveminwalk.toFixed(1) + " cases within a 5 minute walk</li><li>Between " + (nearby.fifteenminwalk / 3).toFixed(1) + " and " + nearby.fifteenminwalk.toFixed(1) + " cases within a 15 minute walk</li></ul>";
                        estimate.innerHTML += "Evidence from other cities shows cases of COVID-19 occur in family/household clusters. The range given above assumes number of cases per household varies from 1 to 3.<br /><br />"
                    });
                });
        });

        function calculateNearbyCases(latitude,longitude){
            N_TRIALS = 10000;

            const center = turf.point([longitude, latitude]);
            const fiveminwalk = turf.circle(center, 0.4);
            const fifteenminwalk = turf.circle(center, 1.2);

            let fifteenminwalk_regions = [];
            for(var i = 0; i < counties.features.length; i++){
                if(counties.features[i].geometry.type != "Polygon"){
                    // console.log("Skipping " + counties.features[i].properties.ctyua15nm)
                    continue;
                }
                if(turf.booleanPointInPolygon(center, counties.features[i])){
                    fifteenminwalk_regions.push(counties.features[i].properties.ctyua15nm);
                } else if(turf.booleanOverlap(counties.features[i], fifteenminwalk)){
                    fifteenminwalk_regions.push(counties.features[i].properties.ctyua15nm);
                }
            }
            if(fifteenminwalk_regions.length==0){
                console.warn('No Matching Regions Found');
            } else {
                console.log("Matching Regions: ", fifteenminwalk_regions);
            }

            let fiveminwalk_counts = []
            let fifteenminwalk_counts = []
            for(var i = 0; i < N_TRIALS; i++){
                let points = null;
                for(var j = 0; j < fifteenminwalk_regions.length; j++){
                    let borough_points_fc = generatePointsInBorough(data[fifteenminwalk_regions[j]].cases, fifteenminwalk_regions[j])
                    if(points != null){
                        let sum_points = borough_points_fc.features.concat(points.features)
                        points.features = sum_points;
                    } else {
                        points = borough_points_fc;
                    }
                }
                let trial_fiveminwalk_count = 0;
                let trial_fifteenminwalk_count = 0;
                for(var j = 0; j < points.features.length; j++){
                    if(turf.booleanPointInPolygon(points.features[j], fiveminwalk)){
                        trial_fiveminwalk_count += 1;
                    }
                    if(turf.booleanPointInPolygon(points.features[j], fifteenminwalk)){
                        trial_fifteenminwalk_count += 1;
                    }
                }
                fiveminwalk_counts.push(trial_fiveminwalk_count)
                fifteenminwalk_counts.push(trial_fifteenminwalk_count)
            }

            return {
                'fiveminwalk': arrayAverage(fiveminwalk_counts),
                'fifteenminwalk': arrayAverage(fifteenminwalk_counts)
            }

        }
        // calculateNearbyCases(51.523599, -0.116263);

        function arrayAverage(values){
            let sum = values.reduce((previous, current) => current += previous);
            return sum / values.length;
        }
        function arrayMedian(values){
            values.sort((a, b) => a - b);
            let lowMiddle = Math.floor((values.length - 1) / 2);
            let highMiddle = Math.ceil((values.length - 1) / 2);
            return (values[lowMiddle] + values[highMiddle]) / 2;
        }

        generatePointsInBorough(20, "Hackney and City of London");

        </script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-1627868-36"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-1627868-36');
</script>

        
</body>
</html>