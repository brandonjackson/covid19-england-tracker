<!doctype html>
<html lang="en">
<head>
    <title>CovidNow: Live Estimates of COVID-19 Cases in the UK</title>
    <meta property="og:title" content="Where Is COVID-19 in London?" />
    <meta property="og:url" content="https://whereisitin.london" />
    <meta property="og:description" content="See where the latest cases of COVID-19 have been confirmed in London.">
    <meta property="og:image" content="https://pbs.twimg.com/media/ESl_gz1XYAEuGmE?format=jpg&name=4096x4096">
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="en_GB" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/jq-3.3.1/dt-1.10.20/datatables.min.css"/>
    <link rel="stylesheet" href="TangleKit/TangleKit.css" type="text/css">
    
    <script src="leaflet/leaflet.js"></script>
    <script src="counties.js"></script>
    <script src="utla_data.js"></script>
    <script src="totals_data.js"></script>
    <script src="sparkline.js"></script>
    <script src="underscore.js"></script>
    <script src="regression.js"></script>
    <script src="Tangle.js"></script>
    <script type="text/javascript" src="TangleKit/mootools.js"></script>
    <script type="text/javascript" src="TangleKit/sprintf.js"></script>
    <script type="text/javascript" src="TangleKit/BVTouchable.js"></script>
    <script type="text/javascript" src="TangleKit/TangleKit.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/jq-3.3.1/dt-1.10.20/datatables.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
</head>
<body>
    <nav class="navbar navbar-dark">
        <a class="navbar-brand" href="#">
            Covid Now: Live Estimates for the UK
        </a>
      </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col">
                <div class="alert alert-warning" role="alert">
                    Like light from a distant star that takes years to reach our eyes, data from the NHS is a snapshot of infections that happened 10+ days ago. To know what's happening <i>right now</i>, this site uses an <a href="#model">interactive model</a> to estimate what happened during that time.
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-2 col-lg-2 col-xl-2">
                <h5>Confirmed Cases</h5>
                <div class="totals" id="inner_london_total">
                    <p class="total_location">Inner London</p>
                    <svg class='sparkline' width='100' height='30' stroke-width='3'></svg>
                    <p class="total_number" >0</p>
                    <p class="total_change" >0</p>
                </div>
                <div class="totals" id="greater_london_total">
                    <p class="total_location">Greater London</p class="total_location">
                    <svg class='sparkline' width='100' height='30' stroke-width='3'></svg>
                    <p class="total_number" >0</p>
                    <p class="total_change" >0</p>
                </div>
                <div class="totals" id="england_total">
                    <p class="total_location">England</p class="total_location">
                    <svg class='sparkline' width='100' height='30' stroke-width='3'></svg>
                    <p class="total_number">0</p>
                    <p class="total_change" >0</p>
                </div>
            </div>
            <div class="col-lg col-xl col-md">
                <h5>Map of <select id="primaryMapVariable">
                    <optgroup label="Estimates Using Model">
                        <option value="estimatedPopulationRate">Cases Per 1000 (Estimated)</option>
                    </optgroup>
                    <optgroup label="Confirmed Data from PHE and NHS">
                        <option value="populationRate">Cases Per 1000 (Confirmed)</option>
                        <option value="areaRate">Cases Per Square Km (Confirmed)</option>
                        <option value="growthRate">Daily Growth Rate (Confirmed)</option>
                        <option value="newCases">New Cases (Confirmed)</option>
                        <option value="cases">Total Cases (Confirmed)</option>
                    </optgroup>
                </select></h5>
                <div id="primarymap"></div>
                <p><button id="play">Play</button> Date: <span id="timeline_date"></span></p>
                <p><small>Data from <a href="https://www.arcgis.com/home/item.html?id=b684319181f94875a6879bbc833ca3a6">Public Health England</a>. Shows situation as of <span id="today"></span> at 0900. New data released every evening.</small></p>        
                <br />
                
            </div>
            <div class="col-md-3 col-lg-3 col-xl-3 ">

                <div class='box'>
                    <h5>Estimate Cases Nearby</h5>
                    <form id='estimationForm'>
                    <div class="input-group mb-3">
                        

                            <input type='text' class='form-control' placeholder='Enter Postcode Here' id='postcode' aria-describedby="get_estimate" />
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-outline-secondary" id='get_estimate'>Estimate</button>
                            </div>
                        
                    </div>
                    <div id='estimate'>

                    </div>
                </form>
                </div>

                
            </div>


        </div>
        <div class="row">
            <div class="col-md-2 col-lg-2 col-xl-2">
            </div>
            <div class="col">
                <h2><a name="model">Interactive Model</a></h2>
                <div class="alert alert-primary" role="alert">
                    <img src="interaction.gif" id="interaction-guide" title="Play with the model!" /> This model is editable. Drag the blue numbers to update the estimates!
                </div>
                <p id="model" class='lead' style='margin-top: 20px;'>
                    Londoners are catching a disease called COVID-19. As they were getting on with their lives, they were sadly infected with the SARS-CoV-2 virus. 
                    <span data-var="incubationPeriod" class="TKAdjustableNumber" data-min="4" data-max="6" title="This is called the incubation period"> days</span> later they began to notice their first symptoms.
                    After <span data-var="testDelay" class="TKAdjustableNumber" data-min="0" data-max="7"> days</span> of being ill, <span data-var="testRate" class="TKAdjustableNumber" data-min="0" data-max="100">%</span> of them were able to get tested. They got the results <span data-var="resultsDelay" class="TKAdjustableNumber" data-min="0" data-max="4"> day</span> later.
                    This means that the <span data-var="confirmed"></span> cases that the NHS has confirmed in London as of <span data-var="dataAge"></span> morning were first infected around <span data-var="preResultsDuration"></span> days ago. 
                    Unfortunately, during that time the virus has been spreading exponentially, at an estimated rate of <span data-var="preLockdownGrowth" class="TKAdjustableNumber" data-min="0" data-max="40">%</span> each day. People are highly contagious for <span data-var="daysContagiousAfter" class="TKAdjustableNumber" data-min="5" data-max="14"> days</span> after symptoms appear...and <span data-var="daysContagiousBefore" class="TKAdjustableNumber" data-min="0" data-max="2"> day</span> before.
                    With these assumptions we can estimate that there are <b><span data-var="cases"></span> infected people</b> in London right now.
                    <b><span data-var="noSymptoms"></span> people</b> don't have symptoms yet.
                    <b><span data-var="contagious"></span> people</b> are contagious.
                </p>
                <h4>Technical Details</h4>
                <p>The estimates are generated using a simple model of exponential growth. The goal of the model is intelligibility, allowing users to explore the data for themselves. The key assumptions of the model are:</p>
                <ul>
                    <li>The NHS data captures infections that occurred many days ago. This delay between infection and data being reported to the public is a constant.</li>
                    <li>The number of cases reported by the NHS consistently underestimates the actual number of cases by a scale factor. This is phrased in the model as the % of people who are sick who get a test.</li>
                    <li>The virus is growing exponentially at a consistent growth rate. Each region grows at this rate. Local estimates are not used due to noisy measurements.</li>
                </ul>
                <p>The rough algorithm for finding the number of infections today is as follows:</p>
                    <ol>
                        <li>Find <var>scaledConfirmedCases</var>: Scale the latest number of confirmed cases by an estimate of what % of people have been tested. For example, if the NHS reports 1965 cases, and 50% are tested, scaledConfirmedCases = 3930 cases.</li>
                        <li>Find <var>delayDays</var>: Estimate the delay between infection and data reporting. For example, if incubation period is 5 days, people get tested after 2 days, and it takes 1 day to get results, then delayDays = 8.</li>
                        <li>Find <var>growthRate</var>: Calculate an average daily growth rate for London. This can be estimated by looking at the growth in official count of cases, or alternatively, by the growth in the official death rate.</li>
                        <li>infectionsToday = scaledConfirmedCases * growthRate ^ delayDays. For example, infectionsToday = 3930 * (1.27)^8 = 26596.</li>
                    </ol>
                    </p>
                <p>How Nearby Estimates Work: The number of nearby cases is calculated in two steps. First, the number of infections in each borough is estimated using the exponential growth model described above. Second, the number of cases nearby is calculated using a simple Monte Carlo method. The postcode is converted into a latitude and longitude point. A circle is drawn of radius 400m (for the 5 minute walk) and 1200m (for the 15 minute walk). For each borough these circles touch, a set of random points equal to the number of estimated cases is generated. The number of cases inside the circles are counted. This is done 1000 times. The average represents the number of cases nearby if each case is spatially isolated. Evidence from <a href='https://chp-dashboard.geodata.gov.hk/covid-19/en.html'>other</a> <a href='https://co.vid19.sg/cases'>cities</a> shows cases of COVID-19 occur in family/household clusters. This pure average is divided by 3 to generate a range, which reflects the situation if the number of cases per household varies from 1 to 3.</p>
                <div id="casesPlot"></div>
            </div>
            <div class="col-md-3 col-lg-3 col-xl-3 "></div>
        </div>
        <div class='row d-none'>
            <div class='col'>
            <h2>New Cases in London</h2>
            <table class="table table-sm" id="new_cases">
                <thead>
                    <tr>
                    <th scope="col">Borough</th>
                    <th scope="col">New</th>
                    <th scope="col">Total</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        </div>


        <div class="row d-none ">
            <div class="col">
            <h5>Regional Data</h5>
            <table class="table display" id="raw_data"></table>
        </div>
        </div>
        </div>
        <footer class="footer">
            <div class="container-fluid">
              <span class="text-muted">whereisitin.london was built by <a href="http://brandonjackson.org">Brandon Jackson</a>. Feedback? Reach me on Twitter at <a href="https://twitter.com/glassboxed">@glassboxed</a>! </span>
            </div>
          </footer>
      
    <script>

        const today = _.last(_.keys(nhs_totals));

        // Population Data Source:
        // https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/populationestimatesforukenglandandwalesscotlandandnorthernireland
        const place_data = {
            "Barking and Dagenham": { "population": 211998, "area": 36, "type": "Greater London" },
            "Barnet": { "population": 392140, "area": 87, "type": "Greater London" },
            "Barnsley": { "population": 245199, "area": 328, "type": "Metropolitan District" },
            "Bath and North East Somerset": { "population": 192106, "area": 350, "type": "Unitary Authority" },
            "Bedford": { "population": 171623, "area": 475, "type": "Unitary Authority" },
            "Bexley": { "population": 247258, "area": 61, "type": "Greater London" },
            "Birmingham": { "population": 1141374, "area": 267, "type": "Metropolitan District" },
            "Blackburn with Darwen": { "population": 148942, "area": 137, "type": "Unitary Authority" },
            "Blackpool": { "population": 139305, "area": 35, "type": "Unitary Authority" },
            "Bolton": { "population": 285372, "area": 140, "type": "Metropolitan District" },
            "Bournemouth, Christchurch and Poole": { "population": 395784, "area": 111, "type": "Unitary Authority" },
            "Bracknell Forest": { "population": 121676, "area": 109, "type": "Unitary Authority" },
            "Bradford": { "population": 537173, "area": 367, "type": "Metropolitan District" },
            "Brent": { "population": 330795, "area": 43, "type": "Greater London" },
            "Brighton and Hove": { "population": 290395, "area": 83, "type": "Unitary Authority" },
            "Bristol, City of": { "population": 463405, "area": 110, "type": "Unitary Authority" },
            "Bromley": { "population": 331096, "area": 150, "type": "Greater London" },
            "Buckinghamshire": { "population": 540059, "area": 1564, "type": "County" },
            "Bury": { "population": 190108, "area": 100, "type": "Metropolitan District" },
            "Calderdale": { "population": 210082, "area": 363, "type": "Metropolitan District" },
            "Cambridgeshire": { "population": 651482, "area": 3052, "type": "County" },
            "Camden": { "population": 262226, "area": 21, "type": "Inner London" },
            "Central Bedfordshire": { "population": 283606, "area": 715, "type": "Unitary Authority" },
            "Cheshire East": { "population": 380790, "area": 1167, "type": "Unitary Authority" },
            "Cheshire West and Chester": { "population": 340502, "area": 913, "type": "Unitary Authority" },
            "Cornwall and Isles of Scilly": { "population": 565968, "area": 3562, "type": "Unitary Authority" },
            "County Durham": { "population": 526980, "area": 2229, "type": "Unitary Authority" },
            "Coventry": { "population": 366785, "area": 98, "type": "Metropolitan District" },
            "Croydon": { "population": 385346, "area": 87, "type": "Greater London" },
            "Cumbria": { "population": 498888, "area": 6810, "type": "County" },
            "Darlington": { "population": 106566, "area": 197, "type": "Unitary Authority" },
            "Derby": { "population": 257174, "area": 79, "type": "Unitary Authority" },
            "Derbyshire": { "population": 796142, "area": 2547, "type": "County" },
            "Devon": { "population": 795286, "area": 6560, "type": "County" },
            "Doncaster": { "population": 310542, "area": 568, "type": "Metropolitan District" },
            "Dorset": { "population": 376484, "area": 2543, "type": "Unitary Authority" },
            "Dudley": { "population": 320626, "area": 97, "type": "Metropolitan District" },
            "Ealing": { "population": 341982, "area": 55, "type": "Greater London" },
            "East Riding of Yorkshire": { "population": 339614, "area": 2403, "type": "Unitary Authority" },
            "East Sussex": { "population": 554590, "area": 1713, "type": "County" },
            "Enfield": { "population": 333869, "area": 82, "type": "Greater London" },
            "Essex": { "population": 1477764, "area": 3462, "type": "County" },
            "Gateshead": { "population": 202508, "area": 143, "type": "Metropolitan District" },
            "Gloucestershire": { "population": 633558, "area": 2651, "type": "County" },
            "Greenwich": { "population": 286186, "area": 47, "type": "Inner London" },
            "Hackney and City of London": { "population": 288371, "area": 22, "type": "Inner London" },
            "Halton": { "population": 128432, "area": 79, "type": "Unitary Authority" },
            "Hammersmith and Fulham": { "population": 185426, "area": 17, "type": "Inner London" },
            "Hampshire": { "population": 1376316, "area": 3678, "type": "County" },
            "Haringey": { "population": 270624, "area": 30, "type": "Greater London" },
            "Harrow": { "population": 250149, "area": 50, "type": "Greater London" },
            "Hartlepool": { "population": 93242, "area": 94, "type": "Unitary Authority" },
            "Havering": { "population": 257810, "area": 112, "type": "Greater London" },
            "Herefordshire, County of": { "population": 192107, "area": 2178, "type": "Unitary Authority" },
            "Hertfordshire": { "population": 1184365, "area": 1643, "type": "County" },
            "Hillingdon": { "population": 304824, "area": 116, "type": "Greater London" },
            "Hounslow": { "population": 270782, "area": 57, "type": "Greater London" },
            "Isle of Wight": { "population": 141538, "area": 380, "type": "Unitary Authority" },
            "Islington": { "population": 239142, "area": 15, "type": "Inner London" },
            "Kensington and Chelsea": { "population": 156197, "area": 12, "type": "Inner London" },
            "Kent": { "population": 1568623, "area": 3736, "type": "County" },
            "Kingston upon Hull, City of": { "population": 260645, "area": 71, "type": "Unitary Authority" },
            "Kingston upon Thames": { "population": 175470, "area": 37, "type": "Greater London" },
            "Kirklees": { "population": 438727, "area": 408, "type": "Metropolitan District" },
            "Knowsley": { "population": 149571, "area": 87, "type": "Metropolitan District" },
            "Lambeth": { "population": 325917, "area": 27, "type": "Inner London" },
            "Lancashire": { "population": 1210053, "area": 2896, "type": "County" },
            "Leeds": { "population": 789194, "area": 551, "type": "Metropolitan District" },
            "Leicester": { "population": 355218, "area": 73, "type": "Unitary Authority" },
            "Leicestershire": { "population": 698268, "area": 2081, "type": "County" },
            "Lewisham": { "population": 303536, "area": 35, "type": "Inner London" },
            "Lincolnshire": { "population": 755833, "area": 5928, "type": "County" },
            "Liverpool": { "population": 494814, "area": 111, "type": "Metropolitan District" },
            "Luton": { "population": 214109, "area": 44, "type": "Unitary Authority" },
            "Manchester": { "population": 547627, "area": 116, "type": "Metropolitan District" },
            "Medway": { "population": 277855, "area": 194, "type": "Unitary Authority" },
            "Merton": { "population": 206186, "area": 37, "type": "Greater London" },
            "Middlesbrough": { "population": 140545, "area": 54, "type": "Unitary Authority" },
            "Milton Keynes": { "population": 268607, "area": 308, "type": "Unitary Authority" },
            "Newcastle upon Tyne": { "population": 300196, "area": 114, "type": "Metropolitan District" },
            "Newham": { "population": 352005, "area": 36, "type": "Greater London" },
            "Norfolk": { "population": 903680, "area": 5371, "type": "County" },
            "North East Lincolnshire": { "population": 159821, "area": 191, "type": "Unitary Authority" },
            "North Lincolnshire": { "population": 172005, "area": 846, "type": "Unitary Authority" },
            "North Somerset": { "population": 213919, "area": 374, "type": "Unitary Authority" },
            "North Tyneside": { "population": 205985, "area": 82, "type": "Metropolitan District" },
            "North Yorkshire": { "population": 614505, "area": 8654, "type": "County" },
            "Northamptonshire": { "population": 747622, "area": 2365, "type": "County" },
            "Northumberland": { "population": 320274, "area": 5019, "type": "Unitary Authority" },
            "Nottingham": { "population": 331069, "area": 75, "type": "Unitary Authority" },
            "Nottinghamshire": { "population": 823126, "area": 2084, "type": "County" },
            "Oldham": { "population": 235623, "area": 142, "type": "Metropolitan District" },
            "Oxfordshire": { "population": 687524, "area": 2604, "type": "County" },
            "Peterborough": { "population": 201041, "area": 344, "type": "Unitary Authority" },
            "Plymouth": { "population": 263100, "area": 80, "type": "Unitary Authority" },
            "Portsmouth": { "population": 215133, "area": 41, "type": "Unitary Authority" },
            "Reading": { "population": 163203, "area": 40, "type": "Unitary Authority" },
            "Redbridge": { "population": 303858, "area": 56, "type": "Greater London" },
            "Redcar and Cleveland": { "population": 136718, "area": 244, "type": "Unitary Authority" },
            "Richmond upon Thames": { "population": 196904, "area": 58, "type": "Greater London" },
            "Rochdale": { "population": 220001, "area": 158, "type": "Metropolitan District" },
            "Rotherham": { "population": 264671, "area": 287, "type": "Metropolitan District" },
            "Rutland": { "population": 39697, "area": 394, "type": "Unitary Authority" },
            "Salford": { "population": 254408, "area": 97, "type": "Metropolitan District" },
            "Sandwell": { "population": 327378, "area": 85, "type": "Metropolitan District" },
            "Sefton": { "population": 275396, "area": 153, "type": "Metropolitan District" },
            "Sheffield": { "population": 582506, "area": 367, "type": "Metropolitan District" },
            "Shropshire": { "population": 320274, "area": 3193, "type": "Unitary Authority" },
            "Slough": { "population": 149112, "area": 32, "type": "Unitary Authority" },
            "Solihull": { "population": 214909, "area": 178, "type": "Metropolitan District" },
            "Somerset": { "population": 559399, "area": 3451, "type": "County" },
            "South Gloucestershire": { "population": 282644, "area": 496, "type": "Unitary Authority" },
            "South Tyneside": { "population": 150265, "area": 65, "type": "Metropolitan District" },
            "Southampton": { "population": 252796, "area": 50, "type": "Unitary Authority" },
            "Southend-on-Sea": { "population": 182463, "area": 42, "type": "Unitary Authority" },
            "Southwark": { "population": 317256, "area": 29, "type": "Inner London" },
            "St. Helens": { "population": 180049, "area": 135, "type": "Metropolitan District" },
            "Staffordshire": { "population": 875219, "area": 2623, "type": "County" },
            "Stockport": { "population": 291775, "area": 126, "type": "Metropolitan District" },
            "Stockton-on-Tees": { "population": 197213, "area": 204, "type": "Unitary Authority" },
            "Stoke-on-Trent": { "population": 255833, "area": 93, "type": "Unitary Authority" },
            "Suffolk": { "population": 758556, "area": 3794, "type": "County" },
            "Sunderland": { "population": 277417, "area": 138, "type": "Metropolitan District" },
            "Surrey": { "population": 1189934, "area": 1669, "type": "County" },
            "Sutton": { "population": 204525, "area": 44, "type": "Greater London" },
            "Swindon": { "population": 221996, "area": 230, "type": "Unitary Authority" },
            "Tameside": { "population": 225197, "area": 103, "type": "Metropolitan District" },
            "Telford and Wrekin": { "population": 177799, "area": 289, "type": "Unitary Authority" },
            "Thurrock": { "population": 172525, "area": 162, "type": "Unitary Authority" },
            "Torbay": { "population": 135780, "area": 63, "type": "Unitary Authority" },
            "Tower Hamlets": { "population": 317705, "area": 20, "type": "Inner London" },
            "Trafford": { "population": 236370, "area": 106, "type": "Metropolitan District" },
            "Wakefield": { "population": 345038, "area": 339, "type": "Metropolitan District" },
            "Walsall": { "population": 283378, "area": 105, "type": "Metropolitan District" },
            "Waltham Forest": { "population": 276700, "area": 39, "type": "Greater London" },
            "Wandsworth": { "population": 326474, "area": 35, "type": "Inner London" },
            "Warrington": { "population": 209547, "area": 181, "type": "Unitary Authority" },
            "Warwickshire": { "population": 571010, "area": 1975, "type": "County" },
            "West Berkshire": { "population": 158527, "area": 702, "type": "Unitary Authority" },
            "West Sussex": { "population": 858852, "area": 1991, "type": "County" },
            "Westminster": { "population": 255324, "area": 22, "type": "Inner London" },
            "Wigan": { "population": 326088, "area": 187, "type": "Metropolitan District" },
            "Wiltshire": { "population": 498064, "area": 3253, "type": "Unitary Authority" },
            "Windsor and Maidenhead": { "population": 150906, "area": 197, "type": "Unitary Authority" },
            "Wirral": { "population": 323235, "area": 158, "type": "Metropolitan District" },
            "Wokingham": { "population": 167979, "area": 180, "type": "Unitary Authority" },
            "Wolverhampton": { "population": 262008, "area": 69, "type": "Metropolitan District" },
            "Worcestershire": { "population": 592057, "area": 1740, "type": "County" },
            "York": { "population": 209893, "area": 272, "type": "Unitary Authority" },
        }

        let modelData = {
            "region": "London",
            "confirmed": 0,
            "incubationPeriod": 5,
            "testRate": 10,
            "testDelay": 5,
            "resultsDelay": 3,
            "daysContagiousBefore": 1,
            "daysContagiousAfter": 7,
            "dataAge": "this",
            "preResultsDuration": 9,
            "cases": 0,
            "contagious": 0,
            "noSymptoms": 0,
            "preLockdownGrowth": 5,
        };

        function generateData(cases){
            let dataObj = {};
            const dates = Object.keys(cases);
            const yesterday = dates[dates.length - 2];
            const today = dates[dates.length - 1];
            for(const place in place_data){
                let region = {}

                // Place Basics
                region.name = place;
                region.population = place_data[place].population;
                region.area = place_data[place].area;
                region.type = place_data[place].type;

                // Case Data
                region.cases = cases[today][place];
                region.newCases = 0;
                if(cases[yesterday] != undefined){
                    region.newCases = region.cases - cases[yesterday][place];
                } else { 
                    region.newCases = region.cases;
                }
                region.caseSeries = [];
                case_list = Object.values(cases);
                for(var i = 0; i < case_list.length; i++){
                    region.caseSeries.push(case_list[i][place]);
                }
                // Stats
                region.populationRate = ((region.cases / region.population) * 1000).toFixed(2);
                region.areaRate = region.cases / region.area;


                region.predictions = [];

                // let dataForRegression = [];
                // for(var i = 0; i < region.caseSeries.length; i++){
                //     dataForRegression.push([i, region.caseSeries[i]]);
                // }

                // const result = regression.exponential(dataForRegression);
                // for(var i = 0; i < result.points.length + 9; i++){
                //     region.predictions.push(result.predict(i + region.caseSeries.length)[1])
                // }
                // region.predictionsR2 = result.r2;
                let prevDay = region.cases / (modelData.testRate / 100);
                for(var i = 0; i < modelData.preResultsDuration; i++){
                    if(i > 0){
                        prevDay = region.predictions[region.predictions.length - 1]
                    }
                    let newDay = prevDay * (1 + (modelData.preLockdownGrowth/100));
                    region.predictions.push(newDay)
                }

                region.estimatedPopulationRate = ((_.last(region.predictions) / region.population) * 1000).toFixed(1);
                region.estimatedAreaRate = _.last(region.predictions) / region.area;

                region.growthRate = Math.round((calculateGrowthRate(region.caseSeries, 4) - 1) * 100);
                if(region.growthRate == NaN){
                    region.growthRate = 0;
                }

                // Save to the list
                dataObj[place] = region;
            }
            return dataObj;
        }

        let data = generateData(cases_archive);
        function setData(newData){
            data = newData;
        }


        function setPrimaryMapData(data, variable){

            const breaks = {
                'cases': [0, 150, 300, 450, 600, 750, 900],
                'newCases': [0, 30, 60, 90, 120, 150, 180],
                'populationRate': [0, 0.3, 0.6, 0.9, 1.2, 1.5, 1.8],
                'estimatedPopulationRate': [0, 8, 16, 24, 32, 40, 48],
                'areaRate': [0, 3, 6, 9, 12, 15, 18],
                'growthRate': [0, 4, 8, 12, 16, 20, 24],
            }

            // function calculateColor(number){
            //     return number > breaks[variable][6] ? '#800026' :
            //         number > breaks[variable][5]  ? '#BD0026' :
            //         number > breaks[variable][4]  ? '#E31A1C' :
            //         number > breaks[variable][3]  ? '#FC4E2A' :
            //         number > breaks[variable][2]   ? '#FD8D3C' :
            //         number > breaks[variable][1]   ? '#FEB24C' :
            //         number > breaks[variable][0]   ? '#FED976' :
            //                         '#FFFFFF';
            // }
            function calculateColor(number){
                return number > breaks[variable][6] ? '#0b253c' :
                    number > breaks[variable][5]  ? '#0e2f65' :
                    number > breaks[variable][4]  ? '#113b92' :
                    number > breaks[variable][3]  ? '#3b5ea5' :
                    number > breaks[variable][2]   ? '#6681b9' :
                    number > breaks[variable][1]   ? '#8ba0ca' :
                    number > breaks[variable][0]   ? '#c2d1f1' :
                                    '#FFFFFF';
            }
            
            primaryMapGeoJSON.setStyle(function(feature){
                return {
                    fillColor: calculateColor(data[feature.properties.ctyua15nm][variable]),
                    weight: 1,
                    opacity: 1,
                    color: 'white',
                    dashArray: '',
                    fillOpacity: 1
                }
            });

            let legend = document.querySelector('.legend');
            legend.innerHTML = "";
            labels = [];
        
            // loop through our density intervals and generate a label with a colored square for each interval
            for (var i = 0; i < breaks[variable].length; i++) {

                if(variable=="populationRate" || variable=="estimatedPopulationRate"){
                    legend.innerHTML +=
                    '<i style="background:' + (calculateColor(breaks[variable][i]*1.000001)) + '"></i> ' +
                    breaks[variable][i] + (breaks[variable][i + 1] ? '<br>' : '+');
                } else if(variable == "areaRate"){
                    legend.innerHTML +=
                        '<i style="background:' + calculateColor(breaks[variable][i]) + '"></i> <= ' +
                        breaks[variable][i] + (breaks[variable][i + 1] ? '' + '<br>' : '+');

                } else if(variable=="cases" || variable == "newCases"){
                    // used for generating ranges...we just need the single values right now
                    legend.innerHTML +=
                        '<i style="background:' + calculateColor(breaks[variable][i]) + '"></i> ' +
                        breaks[variable][i] + (breaks[variable][i + 1] ? '&ndash;' + (breaks[variable][i + 1] - 0.01) + '<br>' : '+');
                } else if(variable=="growthRate"){
                    legend.innerHTML +=
                    '<i style="background:' + (calculateColor(breaks[variable][i]*1.000001)) + '"></i> ' +
                    breaks[variable][i] + (breaks[variable][i + 1] ? '%<br>' : '%+');
                }
            }
        }

        const inner_london = [
            "Camden",
            "Greenwich",
            "Hackney and City of London",
            "Hammersmith and Fulham",
            "Islington",
            "Kensington and Chelsea",
            "Lambeth",
            "Lewisham",
            "Southwark",
            "Tower Hamlets",
            "Wandsworth",
            "Westminster"
        ];

        const greater_london = [
            "Barking and Dagenham",
            "Barnet",
            "Brent",
            "Bromley",
            "Camden",
            "Croydon",
            "Ealing",
            "Enfield",
            "Greenwich",
            "Hackney and City of London",
            "Hammersmith and Fulham",
            "Haringey",
            "Harrow",
            "Havering",
            "Hillingdon",
            "Hounslow",
            "Islington",
            "Kensington and Chelsea",
            "Kingston upon Thames",
            "Lambeth",
            "Lewisham",
            "Merton",
            "Newham",
            "Redbridge",
            "Richmond upon Thames",
            "Southwark",
            "Sutton",
            "Tower Hamlets",
            "Waltham Forest",
            "Wandsworth",
            "Westminster",
        ];


        function getTotalCases(region, date){

            if(date==undefined){
                date = today;
            }
            let total = 0;
            let places = Object.keys(cases_archive[date]);
            let case_counts = Object.values(cases_archive[date]);
            for(var i = 0; i < case_counts.length; i++){
                if(region=="England" 
                    || region==undefined 
                    || (region=="Inner London" && inner_london.includes(places[i]))
                    || (region=="Greater London" && greater_london.includes(places[i]))){
                    
                    total += case_counts[i]
                }
            }
            return total;
        }

        let totals = {
            "England": { total: 0, series: [] },
            "Inner London": { total: 0, series: [] },
            "Greater London": { total: 0, series: [] },
        }

        function calculateAllTotals(){
            let places = Object.keys(totals);
            let dates = Object.keys(cases_archive);
            for(var i = 0; i < places.length; i++){
                totals[places[i]].total = getTotalCases(places[i]);
                for(var j = 0; j < dates.length; j++){
                    totals[places[i]].series.push(getTotalCases(places[i],dates[j]));
                }
                let yesterday = totals[places[i]].series[totals[places[i]].series.length - 2]
                totals[places[i]].newCases = totals[places[i]].total - yesterday;
                totals[places[i]].percentChange = Math.round((totals[places[i]].newCases / yesterday) * 100);
            }
        }
        calculateAllTotals();

        function calculateGrowthRate(data, windowSize){
            if(windowSize==undefined){
                windowSize = data.length - 1
            }
            let start = data[data.length - windowSize - 1]
            let end = data[data.length - 1]
            return Math.pow((end/start),(1/windowSize));
        }

        var primarymap = L.map('primarymap').setView([51.505, -0.09], 9);

        function highlightFeature(e) {
            var layer = e.target;
            layer.setStyle({
                weight: 3,
                color: '#FFF',
                dashArray: '',
                fillOpacity: 1
            });
            info.update(layer.feature.properties);
        }

        function resetHighlight(e) {
            e.target.setStyle({
                weight: 1,
                color: '#FFF',
                dashArray: '',
                fillOpacity: 1
            });
            info.update();
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                click: highlightFeature,
                mouseout: resetHighlight
            });
        }

        let primaryMapGeoJSON = L.geoJson(counties, {
            style: function(feature) {
                return {
                    fillColor: '#FFF',
                    weight: 1,
                    opacity: 1,
                    color: 'white',
                    dashArray: '',
                    fillOpacity: 0.1
                };
            },
            onEachFeature: onEachFeature
        }).addTo(primarymap);

        // Info Box
        var info = L.control();
        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };
        info.update = function (props) {
            let infoHTML = '';
            if(props){
                let region = data[props.ctyua15nm];
                infoHTML += '<h5>' + region.name + '</h5>';
                infoHTML += "<p>Cases growing <b>~" + region.growthRate + "%</b> every day</p>";
                infoHTML  += "<table><tr><td><b>Confirmed:</b><br/><svg class='sparkline confirmed' width='100' height='30' stroke-width='3'></svg>";
                infoHTML  += "<br/>" + region.cases + ' cases';
                if(region.newCases > 0){
                    infoHTML += "<span class='increase'> (▲" + region.newCases + ")</span>";
                }
                if(region.populationRate != undefined){
                    infoHTML  += "<br/>" + region.populationRate + ' per 1000';
                }
                if(region.areaRate != undefined){
                    infoHTML  += "<br/>" + region.areaRate.toFixed(3) + ' per km<sup>2</sup>';
                }
                infoHTML  += "</td>";
                infoHTML  += "<td><b>Estimated:</b><br/><svg class='sparkline estimated' width='100' height='30' stroke-width='3'></svg><br>" + Math.round(_.last(region.predictions)) + " cases";
                if(region.estimatedPopulationRate != undefined){
                    infoHTML  += "<br/>" + region.estimatedPopulationRate + ' per 1000';
                }
                if(region.areaRate != undefined){
                    infoHTML  += "<br/>" + region.estimatedAreaRate.toFixed(3) + ' per km<sup>2</sup>';
                }

                infoHTML += "</td></tr></table>"
                infoHTML += "<div id='logplot' class='d-none d-lg-block d-xl-block'></div>"
                this._div.innerHTML = infoHTML;

                var confirmedLine = {
                    x: _.range(0,region.caseSeries.length),
                    y: region.caseSeries,
                    mode: 'lines',
                    name: 'Solid',
                    line: {
                        dash: 'solid',
                        width: 4,
                        color: '#113b92'
                    }
                };

                var estimatedLine = {
                    x: _.range(region.caseSeries.length - 1 ,region.caseSeries.length + region.predictions.length),
                    y: _.union([_.last(region.caseSeries)], region.predictions),
                    mode: 'lines',
                    name: 'Estimated Cases',
                    line: {
                        dash: 'dot',
                        width: 4,
                        color: '#113b92'
                    },
                };


                var plotlyData = [confirmedLine, estimatedLine];

                var layout = {
                    xaxis: {
                        autorange: true,
                    },
                    yaxis: {
                        type: 'log',
                        range: [0,4]
                    },
                    showlegend: false,
                    margin: {
                        t: 30,
                        r: 30,
                        b: 30,
                        l: 30,
                    },
                    height: 200,
                    width: 200
                };

                Plotly.newPlot('logplot', plotlyData, layout);

                sparkline.sparkline(document.querySelector(".info .sparkline.confirmed"), region.caseSeries);
                sparkline.sparkline(document.querySelector(".info .sparkline.estimated"), _.union(region.caseSeries, region.predictions));
            } else {
                infoHTML +='Hover over a region';
                this._div.innerHTML = infoHTML;
            }
            
        };
        info.addTo(primarymap);

        


        // Create Legend
        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            // add the rest of the stuff when we add data to the map
            return div;
        };
        legend.addTo(primarymap);

        setPrimaryMapData(data, "estimatedPopulationRate");


        function updateTotals(){
            document.querySelector("#inner_london_total .total_number").innerHTML = totals["Inner London"].total;
            document.querySelector("#inner_london_total .total_change").innerHTML = "▲ " + totals["Inner London"].newCases + " (" + totals["Inner London"].percentChange + "%)";
            sparkline.sparkline(document.querySelector("#inner_london_total .sparkline"), totals["Inner London"].series, { interactive: true });
            document.querySelector("#greater_london_total .total_number").innerHTML = totals["Greater London"].total;
            document.querySelector("#greater_london_total .total_change").innerHTML = "▲ " + totals["Greater London"].newCases + " (" + totals["Greater London"].percentChange + "%)";
            sparkline.sparkline(document.querySelector("#greater_london_total .sparkline"), totals["Greater London"].series, { interactive: true });
            document.querySelector("#england_total .total_number").innerHTML = totals["England"].total;
            document.querySelector("#england_total .total_change").innerHTML = "▲ " + totals["England"].newCases + " (" + totals["England"].percentChange + "%)";
            sparkline.sparkline(document.querySelector("#england_total .sparkline"), totals["England"].series, { interactive: true });
        }

        function generateTableData(){
            let rows = []
            for(region in data){
                rows.push([data[region]["name"], data[region]["cases"], data[region]["populationRate"], data[region]["newCases"], (data[region]["cases"] - data[region]["caseSeries"][0])]);
            }
            return rows;
        }

        function getDataForRegression(region, ratioCasesCaught){
            const rows = Object.values(nhs_totals)
            let data = []
            for(var i = 0; i < rows.length; i++){
                data.push([i, rows[i][region] / ratioCasesCaught])
            }
            return data;
        }

        function addDays(date, days) {
            const copy = new Date(Number(date))
            copy.setDate(date.getDate() + days)
            return copy
        }

        let tangleModel = {
            initialize: function () {
                _.extend(this, modelData)
            },
            update: function () {

                this.confirmed = nhs_totals[today][this.region];
                
                this.preResultsDuration = this.incubationPeriod + this.testDelay + this.resultsDelay + 1;

                // if old data add more time
                if((new Date()).toDateString() != (new Date(today)).toDateString()){
                    this.preResultsDuration += 1;
                    this.dataAge = "yesterday";
                }

                // Add predicted data...up until today
                let londonData = getDataForRegression(this.region, this.testRate/100);
                const result = regression.exponential(londonData);
                for(var i = result.points.length; i < result.points.length + this.preResultsDuration; i++){
                    let previousDay = londonData[londonData.length - 1];
                    londonData.push([previousDay[0]+1, previousDay[1] * (1 + (this.preLockdownGrowth / 100))]);
                   // londonData.push(result.predict(i))
                }
                this.cases = Math.round(londonData[londonData.length - 1][1]);

                let enriched = [];
                const data_start_date = new Date(Object.keys(nhs_totals)[0]);
                const start_date = new Date();
                
                let day = 0;
                for(var i = londonData.length - 1; i > 0; i--){
                    let row = {}
                    row.date = addDays(start_date, day*-1).toDateString();
                    row.cases = londonData[i];
                    row.contagious = day >= this.incubationPeriod - this.daysContagiousBefore && day < this.incubationPeriod + this.daysContagiousAfter;
                    row.symptoms = day >= this.incubationPeriod;
                    if(row.contagious){
                        row.color = "#FF0000"
                    } else if(!row.symptoms){
                        row.color = "#c2d1f1"
                    } else {
                        row.color = "#113b92"
                    }
                    if(i > 1){
                        row.newCases = londonData[i][1] - londonData[i-1][1]
                    } else {
                        row.newCases = 0;
                    }
                    enriched.push(row);
                    day += 1;
                }

                let contagiousCount = 0;
                let noSymptomsCount = 0;
                for(var i = 0; i < enriched.length; i++){
                    contagiousCount += enriched[i].contagious ? enriched[i].newCases : 0;
                    noSymptomsCount += !enriched[i].symptoms ? enriched[i].newCases : 0;
                }
                this.contagious = Math.round(contagiousCount);
                this.noSymptoms = Math.round(noSymptomsCount);
                
                var trace1 = {
                    x: _.range(0,enriched.length),
                    y: _.pluck(enriched, "newCases"),
                    marker:{
                        color: _.pluck(enriched, "color")
                    },
                    type: 'bar'
                };

                var data = [trace1];

                var layout = {
                    title: 'Cases'
                };

                modelData = _.clone(this);
                let newData = generateData(cases_archive);
                setData(newData)
                setPrimaryMapData(newData, document.querySelector("#primaryMapVariable").value)
            }
        };

        $(document).ready(function() {
            document.querySelector('#primaryMapVariable').addEventListener('change', (event)=>{
                console.log(modelData);
                console.log(data);
                setPrimaryMapData(data, event.target.value)
            });
            updateTotals();
            generateNewCasesTable();
            document.querySelector("#today").innerHTML = today;
            $('#raw_data').DataTable( {
                data: generateTableData(),
                columns: [
                    { title: "Name" },
                    { title: "Cases (Total)" },
                    { title: "Cases (Per 1000)" },
                    { title: "▲ Daily" },
                    { title: "▲ Weekly" }
                ],
                order: [[ 2, "desc" ]]
            });

            var tangleHTML = document.getElementById("model");
            var tangle = new Tangle(tangleHTML, tangleModel);

        } );


        function generateNewCasesTable(){
            var sortable = []
            for(var i = 0; i < greater_london.length; i++){
                let region = data[greater_london[i]];
                sortable.push([greater_london[i],region.newCases, region.cases]);
            }
            sortable.sort(function(a, b){
                return b[1] - a[1]
            });

            var table = document.getElementById("new_cases");
            for(var i = 0; i < sortable.length; i++){
                if(sortable[i][1] > 0){
                    var row = table.insertRow();
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    var cell3 = row.insertCell(2);
                    cell1.innerHTML = sortable[i][0];
                    cell2.innerHTML =  "▲ " + sortable[i][1];
                    cell3.innerHTML =  sortable[i][2];
                }
            }
        }


        function getBoroughGeoJSON(borough_name){
            var borough_geojson = null;
            for(var i = 0; i < counties.features.length; i++){
                if(counties.features[i].properties.ctyua15nm == borough_name){
                    borough_geojson = counties.features[i];
                    break;
                }
            }
            return borough_geojson;
        }

        function generatePointsInBorough(n, borough_name){
            let borough_geojson = getBoroughGeoJSON(borough_name);
            var bbox = turf.bbox(borough_geojson);
            var points = [];
            while(points.length < n){
                var point = turf.randomPoint(1, {bbox: bbox});
                if(turf.booleanPointInPolygon(point.features[0], borough_geojson)){
                    points.push(point.features[0]);
                }
            }
            return turf.featureCollection(points);
        }

        let form = document.querySelector('#estimationForm');
        form.addEventListener('submit', function(e){
            e.preventDefault();
            let postcode = document.querySelector("#postcode").value.replace(/\s/g,'');
            fetch('https://api.postcodes.io/postcodes/' + postcode)
                .then(response => {
                    response.json().then(function(data) {
                        console.log(data.result);
                        let center = [data.result.latitude, data.result.longitude];
                        let nearby = calculateNearbyCases(center[0], center[1]);
                        
                        // Add circles to map
                        primarymap.setView(center, 14);
                        
                        L.circle(center, {
                            weight: 2,
                            radius: 400,
                            dashArray: '4 4',
                            color: '#333',
                            fillOpacity: 0
                        }).addTo(primarymap);
                        L.circle(center, {
                            weight: 2,
                            radius: 1200,
                            dashArray: '4 4',
                            color: '#333',
                            fillOpacity: 0
                        }).addTo(primarymap);

                        console.log(nearby);

                        let estimate = document.querySelector('#estimate');
                        let estimateHTML = ""
                        let contagiousRate = modelData.contagious / modelData.cases;
                        let asymptomaticRate = modelData.noSymptoms / modelData.cases;
                        estimateHTML += data.result.postcode + " is located in <b>" + data.result.admin_district + "</b>. The model estimates that within a <b>5 minute walk</b> there are:";
                        estimateHTML += "<ul>";
                        estimateHTML += "<li>Between " + Math.round(nearby.fiveminwalk / 3) + " and " + Math.round(nearby.fiveminwalk) + " cases</li>";
                        estimateHTML += "<li>Between " + Math.round((nearby.fiveminwalk / 3)*contagiousRate) + " and " + Math.round(nearby.fiveminwalk * contagiousRate) + " are contagious</li>";
                        estimateHTML += "<li>Between " + Math.round((nearby.fiveminwalk / 3)*asymptomaticRate ) + " and " + Math.round(nearby.fiveminwalk * asymptomaticRate ) + " don't have symptoms yet</li>";
                        estimateHTML += "</ul>"
                        estimateHTML += "<p>Within a <b>15 minute walk</b> there are:</p>"
                        estimateHTML += "<ul>";
                        estimateHTML += "<li>Between " + Math.round(nearby.fifteenminwalk / 3) + " and " + Math.round(nearby.fifteenminwalk) + " cases</li>";
                        estimateHTML += "<li>Between " + Math.round((nearby.fifteenminwalk / 3)*contagiousRate) + " and " + Math.round(nearby.fifteenminwalk * contagiousRate) + " are contagious</li>";
                        estimateHTML += "<li>Between " + Math.round((nearby.fifteenminwalk / 3)*asymptomaticRate ) + " and " + Math.round(nearby.fifteenminwalk * asymptomaticRate ) + " don't have symptoms yet</li>";
                        estimateHTML += "</ul>"
                        estimateHTML += "<small>⚠️ These numbers are <em>estimates</em> based on the number of infections predicted to be active in the surrounding boroughs: " + nearby.regions.join(",") + ". Read more in <a href='#model'>How the Model Works</a> section.</small><br /><br />"
                        estimate.innerHTML = estimateHTML;
                    });
                });
        });

        function calculateNearbyCases(latitude,longitude){
            N_TRIALS = 100;

            const center = turf.point([longitude, latitude]);
            const fiveminwalk = turf.circle(center, 0.4);
            const fifteenminwalk = turf.circle(center, 1.2);

            let fifteenminwalk_regions = [];
            for(var i = 0; i < counties.features.length; i++){
                if(counties.features[i].geometry.type != "Polygon"){
                    continue;
                }
                if(turf.booleanPointInPolygon(center, counties.features[i])){
                    fifteenminwalk_regions.push(counties.features[i].properties.ctyua15nm);
                } else if(turf.booleanOverlap(counties.features[i], fifteenminwalk)){
                    fifteenminwalk_regions.push(counties.features[i].properties.ctyua15nm);
                }
            }
            if(fifteenminwalk_regions.length==0){
                console.warn('No Matching Regions Found');
            } else {
                console.log("Matching Regions: ", fifteenminwalk_regions);
            }

            let fiveminwalk_counts = []
            let fifteenminwalk_counts = []
            for(var i = 0; i < N_TRIALS; i++){
                let points = null;
                for(var j = 0; j < fifteenminwalk_regions.length; j++){
                    let borough_points_fc = generatePointsInBorough(_.last(data[fifteenminwalk_regions[j]].predictions), fifteenminwalk_regions[j])
                    if(points != null){
                        let sum_points = borough_points_fc.features.concat(points.features)
                        points.features = sum_points;
                    } else {
                        points = borough_points_fc;
                    }
                }
                let trial_fiveminwalk_count = 0;
                let trial_fifteenminwalk_count = 0;
                for(var j = 0; j < points.features.length; j++){
                    if(turf.booleanPointInPolygon(points.features[j], fiveminwalk)){
                        trial_fiveminwalk_count += 1;
                    }
                    if(turf.booleanPointInPolygon(points.features[j], fifteenminwalk)){
                        trial_fifteenminwalk_count += 1;
                    }
                }
                fiveminwalk_counts.push(trial_fiveminwalk_count)
                fifteenminwalk_counts.push(trial_fifteenminwalk_count)
            }

            return {
                'regions': fifteenminwalk_regions,
                'fiveminwalk': arrayAverage(fiveminwalk_counts),
                'fifteenminwalk': arrayAverage(fifteenminwalk_counts)
            }

        }
        // calculateNearbyCases(51.523599, -0.116263);

        function arrayAverage(values){
            let sum = values.reduce((previous, current) => current += previous);
            return sum / values.length;
        }
        function arrayMedian(values){
            values.sort((a, b) => a - b);
            let lowMiddle = Math.floor((values.length - 1) / 2);
            let highMiddle = Math.ceil((values.length - 1) / 2);
            return (values[lowMiddle] + values[highMiddle]) / 2;
        }

        let isPlaying = false;
        let animationInterval = null;
        let dates = Object.keys(cases_archive);
        let dateIndex = dates.length - 1;
        let playButton = document.querySelector('#play');
        let timelineDate = document.querySelector('#timeline_date');
        timelineDate.innerHTML = today;
        
        playButton.addEventListener('click',function(e){
            if(!isPlaying){
                playButton.innerHTML = "Pause";
                animationInterval = setInterval(()=>{
                    
                    dateIndex = (dateIndex + 1) % dates.length;
                    let tempCaseObject = {}
                    tempCaseObject[dates[dateIndex]] = cases_archive[dates[dateIndex]]
                    setPrimaryMapData(generateData(tempCaseObject), document.querySelector("#primaryMapVariable").value);
                    timelineDate.innerHTML = dates[dateIndex];
                }, 1000);
            } else {
                playButton.innerHTML = "Play";
                clearInterval(animationInterval);
            }
            
            isPlaying = !isPlaying;
        });


        </script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-1627868-36"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-1627868-36');
</script>

        
</body>
</html>