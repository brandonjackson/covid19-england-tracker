<!doctype html>
<html lang="en">
<head>
    <title>Where Is COVID-19 in London?</title>
    <meta property="og:title" content="Where Is COVID-19 in London?" />
    <meta property="og:url" content="https://whereisitin.london" />
    <meta property="og:description" content="See where the latest cases of COVID-19 have been confirmed in London.">
    <meta property="og:image" content="https://pbs.twimg.com/media/ESl_gz1XYAEuGmE?format=jpg&name=4096x4096">
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="en_GB" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="leaflet/leaflet.js"></script>
    <script src="counties.js"></script>
    <script src="sparkline.js"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src="https://unpkg.com/random-points-generator"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
</head>
<body>
    <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="#">
            COVID-19 Cases in England
        </a>
      </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 col-lg-2 col-xl-2">
                <h5>Confirmed Cases</h5>
                <div class="totals" id="inner_london_total">
                    <svg class='sparkline' width='100' height='30' stroke-width='3'></svg>
                    <p class="total_number" >0</p>
                    <p class="total_location">Inner London</p>
                </div>
                <div class="totals" id="greater_london_total">
                    <svg class='sparkline' width='100' height='30' stroke-width='3'></svg>
                    <p class="total_number" >0</p>
                    <p class="total_location">Greater London</p class="total_location">
                </div>
                <div class="totals" id="england_total">
                    <svg class='sparkline' width='100' height='30' stroke-width='3'></svg>
                    <p class="total_number">0</p>
                    <p class="total_location">England</p class="total_location">
                </div>
            </div>
            <div class="col-lg col-xl">
                <h5>Map</h5>
                <div id="primarymap"></div>
                <p>Data from <a href="https://www.gov.uk/government/publications/coronavirus-covid-19-number-of-cases-in-england/coronavirus-covid-19-number-of-cases-in-england">Public Health England</a>, accurate as of 2020-03-08 at 0900</p>        
                <br />
                <h5>London Boroughs</h5>
                <select id="borough-picker"></select>
                <p><b><span id="borough_total">0</span></b> cases have been confirmed in <b><span id="borough_name">Hackney</span></b>.</p>
                <p>We don't have data about where exactly the cases are. Here is a simulation of what that number of cases might look like spread <em>randomly</em> across the borough.</p>
                <div id="localmap"></div>

            </div>
            <div class="col-md-3 col-lg-3 col-xl-3 ">
                <h5>New Cases</h5>
                <table class="table" id="new_cases">
                    <thead>
                        <tr>
                          <th scope="col">Borough</th>
                          <th scope="col">New</th>
                          <th scope="col">Total</th>
                        </tr>
                      </thead>
                      <tbody>

                      </tbody>
                </table>
                
            </div>


        </div>
        </div>
    <script>

        const today = "2020-03-08";
        const yesterday = "2020-03-07";

        const places = {
            "Hackney": "Hackney and City of London",
            "City of London": "Hackney and City of London",
            "Cornwall": "Cornwall and Isles of Scilly",
            "Isles of Scilly": "Cornwall and Isles of Scilly",
        };
        const cases_archive = {
            "2020-03-05": {"Barking and Dagenham": 0,"Barnet": 3,"Barnsley": 2,"Bath and North East Somerset": 0,"Bedford": 0,"Bexley": 0,"Birmingham": 1,"Blackburn with Darwen": 0,"Blackpool": 0,"Bolton": 1,"Bournemouth, Christchurch and Poole": 0,"Bracknell Forest": 0,"Bradford": 1,"Brent": 0,"Brighton and Hove": 6,"Bristol, City of": 0,"Bromley": 1,"Buckinghamshire": 0,"Bury": 4,"Calderdale": 0,"Cambridgeshire": 0,"Camden": 2,"Central Bedfordshire": 0,"Cheshire East": 0,"Cheshire West and Chester": 0,"Cornwall and Isles of Scilly": 2,"County Durham": 0,"Coventry": 0,"Croydon": 0,"Cumbria": 0,"Darlington": 0,"Derby": 0,"Derbyshire": 3,"Devon": 7,"Doncaster": 0,"Dorset": 0,"Dudley": 0,"Ealing": 4,"East Riding of Yorkshire": 0,"East Sussex": 0,"Enfield": 0,"Essex": 3,"Gateshead": 0,"Gloucestershire": 3,"Greenwich": 0,"Hackney and City of London": 0,"Halton": 0,"Hammersmith and Fulham": 0,"Hampshire": 2,"Haringey": 0,"Harrow": 1,"Hartlepool": 0,"Havering": 0,"Herefordshire, County of": 0,"Hertfordshire": 5,"Hillingdon": 0,"Hounslow": 3,"Isle of Wight": 0,"Islington": 0,"Kensington and Chelsea": 4,"Kent": 2,"Kingston upon Hull, City of": 1,"Kingston upon Thames": 1,"Kirklees": 0,"Knowsley": 0,"Lambeth": 0,"Lancashire": 2,"Leeds": 3,"Leicester": 0,"Leicestershire": 0,"Lewisham": 2,"Lincolnshire": 1,"Liverpool": 0,"Luton": 0,"Manchester": 4,"Medway": 0,"Merton": 1,"Middlesbrough": 0,"Milton Keynes": 0,"Newcastle upon Tyne": 3,"Newham": 0,"Norfolk": 0,"North East Lincolnshire": 0,"North Lincolnshire": 0,"North Somerset": 0,"North Tyneside": 0,"North Yorkshire": 0,"Northamptonshire": 2,"Northumberland": 0,"Nottingham": 2,"Nottinghamshire": 0,"Oldham": 2,"Oxfordshire": 4,"Peterborough": 1,"Plymouth": 0,"Portsmouth": 0,"Reading": 0,"Redbridge": 0,"Redcar and Cleveland": 0,"Richmond upon Thames": 0,"Rochdale": 0,"Rotherham": 0,"Rutland": 0,"Salford": 0,"Sandwell": 0,"Sefton": 0,"Sheffield": 0,"Shropshire": 0,"Slough": 0,"Solihull": 0,"Somerset": 1,"South Gloucestershire": 0,"South Tyneside": 0,"Southampton": 0,"Southend-on-Sea": 0,"Southwark": 1,"St. Helens": 0,"Staffordshire": 4,"Stockport": 0,"Stockton-on-Tees": 0,"Stoke-on-Trent": 0,"Suffolk": 0,"Sunderland": 0,"Surrey": 4,"Sutton": 0,"Swindon": 0,"Tameside": 0,"Telford and Wrekin": 0,"Thurrock": 0,"Torbay": 4,"Tower Hamlets": 0,"Trafford": 4,"Wakefield": 0,"Walsall": 0,"Waltham Forest": 0,"Wandsworth": 2,"Warrington": 0,"Warwickshire": 0,"West Berkshire": 0,"West Sussex": 3,"Westminster": 0,"Wigan": 3,"Wiltshire": 3,"Windsor and Maidenhead": 0,"Wirral": 1,"Wokingham": 2,"Wolverhampton": 0,"Worcestershire": 0,"York": 3,"awaiting clarification": 8},
            "2020-03-07": {"Barking and Dagenham": 0,"Barnet": 3,"Barnsley": 2,"Bath and North East Somerset": 0,"Bedford": 0,"Bexley": 0,"Birmingham": 1,"Blackburn with Darwen": 0,"Blackpool": 0,"Bolton": 1,"Bournemouth, Christchurch and Poole": 0,"Bracknell Forest": 2,"Bradford": 1,"Brent": 1,"Brighton and Hove": 7,"Bristol, City of": 1,"Bromley": 1,"Buckinghamshire": 1,"Bury": 4,"Calderdale": 0,"Cambridgeshire": 0,"Camden": 2,"Central Bedfordshire": 0,"Cheshire East": 0,"Cheshire West and Chester": 0,"Cornwall and Isles of Scilly": 2,"County Durham": 0,"Coventry": 1,"Croydon": 0,"Cumbria": 4,"Darlington": 0,"Derby": 0,"Derbyshire": 3,"Devon": 10,"Doncaster": 0,"Dorset": 0,"Dudley": 0,"Ealing": 5,"East Riding of Yorkshire": 0,"East Sussex": 0,"Enfield": 0,"Essex": 3,"Gateshead": 0,"Gloucestershire": 3,"Greenwich": 0,"Hackney and City of London": 2,"Halton": 0,"Hammersmith and Fulham": 1,"Hampshire": 2,"Haringey": 0,"Harrow": 1,"Hartlepool": 0,"Havering": 0,"Herefordshire, County of": 0,"Hertfordshire": 8,"Hillingdon": 1,"Hounslow": 3,"Isle of Wight": 1,"Islington": 0,"Kensington and Chelsea": 6,"Kent": 2,"Kingston upon Hull, City of": 1,"Kingston upon Thames": 1,"Kirklees": 0,"Knowsley": 0,"Lambeth": 2,"Lancashire": 2,"Leeds": 3,"Leicester": 0,"Leicestershire": 1,"Lewisham": 2,"Lincolnshire": 1,"Liverpool": 3,"Luton": 2,"Manchester": 5,"Medway": 2,"Merton": 1,"Middlesbrough": 0,"Milton Keynes": 1,"Newcastle upon Tyne": 3,"Newham": 0,"Norfolk": 0,"North East Lincolnshire": 0,"North Lincolnshire": 0,"North Somerset": 0,"North Tyneside": 1,"North Yorkshire": 0,"Northamptonshire": 2,"Northumberland": 0,"Nottingham": 2,"Nottinghamshire": 3,"Oldham": 2,"Oxfordshire": 4,"Peterborough": 1,"Plymouth": 0,"Portsmouth": 0,"Reading": 0,"Redbridge": 1,"Redcar and Cleveland": 0,"Richmond upon Thames": 0,"Rochdale": 0,"Rotherham": 0,"Rutland": 0,"Salford": 0,"Sandwell": 0,"Sefton": 0,"Sheffield": 0,"Shropshire": 0,"Slough": 0,"Solihull": 0,"Somerset": 1,"South Gloucestershire": 0,"South Tyneside": 0,"Southampton": 0,"Southend-on-Sea": 1,"Southwark": 1,"St. Helens": 0,"Staffordshire": 4,"Stockport": 0,"Stockton-on-Tees": 0,"Stoke-on-Trent": 0,"Suffolk": 0,"Sunderland": 0,"Surrey": 4,"Sutton": 0,"Swindon": 1,"Tameside": 0,"Telford and Wrekin": 0,"Thurrock": 0,"Torbay": 4,"Tower Hamlets": 0,"Trafford": 4,"Wakefield": 0,"Walsall": 0,"Waltham Forest": 0,"Wandsworth": 2,"Warrington": 0,"Warwickshire": 0,"West Berkshire": 0,"West Sussex": 3,"Westminster": 2,"Wigan": 3,"Wiltshire": 3,"Windsor and Maidenhead": 0,"Wirral": 1,"Wokingham": 2,"Wolverhampton": 0,"Worcestershire": 0,"York": 3,"awaiting clarification": 14},
            "2020-03-08": {"Barking and Dagenham": 0,"Barnet": 4,"Barnsley": 2,"Bath and North East Somerset": 0,"Bedford": 0,"Bexley": 0,"Birmingham": 1,"Blackburn with Darwen": 0,"Blackpool": 0,"Bolton": 2,"Bournemouth, Christchurch and Poole": 2,"Bracknell Forest": 2,"Bradford": 1,"Brent": 3,"Brighton and Hove": 7,"Bristol, City of": 2,"Bromley": 1,"Buckinghamshire": 1,"Bury": 3,"Calderdale": 0,"Cambridgeshire": 0,"Camden": 2,"Central Bedfordshire": 0,"Cheshire East": 0,"Cheshire West and Chester": 0,"Cornwall and Isles of Scilly": 3,"County Durham": 0,"Coventry": 3,"Croydon": 0,"Cumbria": 5,"Darlington": 0,"Derby": 0,"Derbyshire": 4,"Devon": 12,"Doncaster": 0,"Dorset": 0,"Dudley": 0,"Ealing": 5,"East Riding of Yorkshire": 0,"East Sussex": 0,"Enfield": 0,"Essex": 5,"Gateshead": 0,"Gloucestershire": 3,"Greenwich": 0,"Hackney and City of London": 2,"Halton": 0,"Hammersmith and Fulham": 2,"Hampshire": 8,"Haringey": 0,"Harrow": 1,"Hartlepool": 0,"Havering": 0,"Herefordshire, County of": 0,"Hertfordshire": 13,"Hillingdon": 1,"Hounslow": 3,"Isle of Wight": 1,"Islington": 0,"Kensington and Chelsea": 8,"Kent": 4,"Kingston upon Hull, City of": 1,"Kingston upon Thames": 1,"Kirklees": 0,"Knowsley": 0,"Lambeth": 3,"Lancashire": 4,"Leeds": 3,"Leicester": 0,"Leicestershire": 1,"Lewisham": 3,"Lincolnshire": 1,"Liverpool": 4,"Luton": 2,"Manchester": 5,"Medway": 2,"Merton": 1,"Middlesbrough": 0,"Milton Keynes": 1,"Newcastle upon Tyne": 3,"Newham": 0,"Norfolk": 0,"North East Lincolnshire": 0,"North Lincolnshire": 0,"North Somerset": 0,"North Tyneside": 1,"North Yorkshire": 0,"Northamptonshire": 4,"Northumberland": 0,"Nottingham": 2,"Nottinghamshire": 3,"Oldham": 2,"Oxfordshire": 5,"Peterborough": 1,"Plymouth": 0,"Portsmouth": 0,"Reading": 0,"Redbridge": 1,"Redcar and Cleveland": 0,"Richmond upon Thames": 0,"Rochdale": 0,"Rotherham": 0,"Rutland": 0,"Salford": 0,"Sandwell": 0,"Sefton": 0,"Sheffield": 0,"Shropshire": 0,"Slough": 0,"Solihull": 0,"Somerset": 2,"South Gloucestershire": 0,"South Tyneside": 0,"Southampton": 0,"Southend-on-Sea": 1,"Southwark": 3,"St. Helens": 0,"Staffordshire": 4,"Stockport": 0,"Stockton-on-Tees": 0,"Stoke-on-Trent": 0,"Suffolk": 0,"Sunderland": 0,"Surrey": 5,"Sutton": 0,"Swindon": 2,"Tameside": 1,"Telford and Wrekin": 0,"Thurrock": 0,"Torbay": 6,"Tower Hamlets": 1,"Trafford": 4,"Wakefield": 0,"Walsall": 0,"Waltham Forest": 0,"Wandsworth": 3,"Warrington": 0,"Warwickshire": 3,"West Berkshire": 0,"West Sussex": 3,"Westminster": 3,"Wigan": 3,"Wiltshire": 3,"Windsor and Maidenhead": 0,"Wirral": 1,"Wokingham": 3,"Wolverhampton": 0,"Worcestershire": 0,"York": 3,"Awaiting confirmation": 20,}
        }

        function getInfoFromLAD(lad){
            data = {
                "name": undefined,
                "cases": undefined,
                "newCases": undefined,
                "rate": undefined,
            };
            cases = cases_archive[today];
            if(cases[lad] != undefined){
                data.name = lad;
            } else if(cases[places[lad]]!= undefined){
                data.name = places[lad];
            } else {
                console.log("Missing Place! LAD = " + lad);
            }
            data.cases = cases_archive[today][data.name];
            if(cases_archive[yesterday] != undefined){
                data.newCases = data.cases - cases_archive[yesterday][data.name];
            }
            

            data.caseSeries = [];
            case_list = Object.values(cases_archive);
            for(var i = 0; i < case_list.length; i++){
                data.caseSeries.push(case_list[i][data.name]);
            }

            if(london_populations[data.name] != undefined){
                data.rate = data.cases / london_populations[data.name];
            }

            data.color = getColor(data.cases);
            return data;
        }


        const inner_london = [
            "Camden",
            "Greenwich",
            "Hackney and City of London",
            "Hammersmith and Fulham",
            "Islington",
            "Kensington and Chelsea",
            "Lambeth",
            "Lewisham",
            "Southwark",
            "Tower Hamlets",
            "Wandsworth",
            "Westminster"
        ];

        const greater_london = [
            "Barking and Dagenham",
            "Barnet",
            "Brent",
            "Bromley",
            "Camden",
            "Croydon",
            "Ealing",
            "Enfield",
            "Greenwich",
            "Hackney and City of London",
            "Hammersmith and Fulham",
            "Haringey",
            "Harrow",
            "Havering",
            "Hillingdon",
            "Hounslow",
            "Islington",
            "Kensington and Chelsea",
            "Kingston upon Thames",
            "Lambeth",
            "Lewisham",
            "Merton",
            "Newham",
            "Redbridge",
            "Richmond upon Thames",
            "Southwark",
            "Sutton",
            "Tower Hamlets",
            "Waltham Forest",
            "Wandsworth",
            "Westminster",
        ];

        // taken from here
        // https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/populationestimatesforukenglandandwalesscotlandandnorthernireland
        const london_populations = {
            "Barking and Dagenham": 211998,
            "Barnet": 392140,
            "Bexley": 247258,
            "Brent": 330795,
            "Bromley": 331096,
            "Camden": 262226,
            "Croydon": 385346,
            "Ealing": 341982,
            "Enfield": 333869,
            "Greater London": 8908081,
            "Greenwich": 286186,
            "Hackney and City of London": 288371,
            "Hammersmith and Fulham": 185426,
            "Haringey": 270624,
            "Harrow": 250149,
            "Havering": 257810,
            "Hillingdon": 304824,
            "Hounslow": 270782,
            "Inner London": 3263760,
            "Islington": 239142,
            "Kensington and Chelsea": 156197,
            "Kingston upon Thames": 175470,
            "Lambeth": 325917,
            "Lewisham": 303536,
            "Merton": 206186,
            "Newham": 352005,
            "Redbridge": 303858,
            "Richmond upon Thames": 196904,
            "Southwark": 317256,
            "Sutton": 204525,
            "Tower Hamlets": 317705,
            "Waltham Forest": 276700,
            "Wandsworth": 326474,
            "Westminster": 255324
        }

        function getTotalCases(region, date){

            if(date==undefined){
                date = today;
            }
            let total = 0;
            let places = Object.keys(cases_archive[date]);
            let case_counts = Object.values(cases_archive[date]);
            for(var i = 0; i < case_counts.length; i++){
                if(region=="England" 
                    || region==undefined 
                    || (region=="Inner London" && inner_london.includes(places[i]))
                    || (region=="Greater London" && greater_london.includes(places[i]))){
                    
                    total += case_counts[i]
                }
            }
            return total;
        }

        let totals = {
            "England": { total: 0, series: [] },
            "Inner London": { total: 0, series: [] },
            "Greater London": { total: 0, series: [] },
        }

        function calculateAllTotals(){
            let places = Object.keys(totals);
            let dates = Object.keys(cases_archive);
            for(var i = 0; i < places.length; i++){
                totals[places[i]].total = getTotalCases(places[i]);
                for(var j = 0; j < dates.length; j++){
                    totals[places[i]].series.push(getTotalCases(places[i],dates[j]));
                }
            }
        }
        calculateAllTotals();

        function getColor(number){
            return number > 32 ? '#800026' :
            number > 16  ? '#BD0026' :
            number > 8  ? '#E31A1C' :
            number > 4  ? '#FC4E2A' :
            number > 2   ? '#FD8D3C' :
            number > 1   ? '#FEB24C' :
            number > 0   ? '#FED976' :
                            '#FFFFFF';

        }

        var primarymap = L.map('primarymap').setView([51.505, -0.09], 10);
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: 'pk.eyJ1IjoiYnJhbmRvbmphY2tzb24iLCJhIjoiY2s3aTFuYXZwMGY0ODNubW45d24yMGUxMiJ9.ruZUCY7P0KzZYhzDU_aQRg'
        }).addTo(primarymap);

        function style(feature) {
            return {
                fillColor: getInfoFromLAD(feature.properties.ctyua15nm)["color"],
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '',
                fillOpacity: 0.7
            };
        }

        function highlightFeature(e) {
            var layer = e.target;

            layer.setStyle({
                weight: 5,
                color: '#666',
                dashArray: '',
                fillOpacity: 0.7
            });

            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }

            info.update(layer.feature.properties);
        }

        function resetHighlight(e) {

            e.target.setStyle({
                weight: 2,
                color: '#FFF',
                dashArray: '',
                fillOpacity: 0.7
            });

            info.update();

        }


        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                click: highlightFeature,
                mouseout: resetHighlight
            });
        }

        L.geoJson(counties, {
            style: style,
            onEachFeature: onEachFeature
        }).addTo(primarymap);

        var info = L.control();

        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
            this.update();
            return this._div;
        };

        // method that we will use to update the control based on feature properties passed
        info.update = function (props) {
            
            this._div.innerHTML = '';
            if(props){
                let data = getInfoFromLAD(props.ctyua15nm);
                this._div.innerHTML += '<h5>' + data.name + '</h5>';
                this._div.innerHTML += "<svg class='sparkline' width='100' height='30' stroke-width='3'></svg>";

                this._div.innerHTML += "<br/>" + data.cases + ' cases';
                if(data.newCases > 0){
                    this._div.innerHTML += "<span style='color: red;'> (▲" + data.newCases + ")</span>";
                }
                if(data.rate != undefined){
                    this._div.innerHTML += "<br/>" + (data.rate * 100).toFixed(3) + '% of population';
                }

                sparkline.sparkline(document.querySelector(".info .sparkline"), data.caseSeries);
            } else {
                this._div.innerHTML +='Hover over a region';
            }
        };

        info.addTo(primarymap);

        var legend = L.control({position: 'bottomright'});

        legend.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legend'),
                grades = [0, 1, 2, 4, 8, 16, 32],
                labels = [];

            // loop through our density intervals and generate a label with a colored square for each interval
            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(grades[i]+1) + '"></i> ' +
                    grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
            }

            return div;
        };

        legend.addTo(primarymap);

        function updateTotals(){
            document.querySelector("#inner_london_total .total_number").innerHTML = totals["Inner London"].total;
            sparkline.sparkline(document.querySelector("#inner_london_total .sparkline"), totals["Inner London"].series, { interactive: true });
            document.querySelector("#greater_london_total .total_number").innerHTML = totals["Greater London"].total;
            sparkline.sparkline(document.querySelector("#greater_london_total .sparkline"), totals["Greater London"].series, { interactive: true });
            document.querySelector("#england_total .total_number").innerHTML = totals["England"].total;
            sparkline.sparkline(document.querySelector("#england_total .sparkline"), totals["England"].series, { interactive: true });
        }

        function generateNewCasesTable(){
            var sortable = []
            for(var i = 0; i < greater_london.length; i++){
                let data = getInfoFromLAD(greater_london[i]);
                sortable.push([greater_london[i],data.newCases,data.cases]);
            }
            sortable.sort(function(a, b){
                return b[1] - a[1]
            });

            var table = document.getElementById("new_cases");
            for(var i = 0; i < sortable.length; i++){
                var row = table.insertRow();
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
                var cell3 = row.insertCell(2);
                cell1.innerHTML = sortable[i][0];
                if(sortable[i][1] > 0){
                    cell2.innerHTML =  "▲ " + sortable[i][1];
                }

                cell3.innerHTML =  sortable[i][2];
            }
        }

        updateTotals();
        generateNewCasesTable();


        var localmap = L.map('localmap').setView([51.505, -0.09], 10);
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: 'pk.eyJ1IjoiYnJhbmRvbmphY2tzb24iLCJhIjoiY2s3aTFuYXZwMGY0ODNubW45d24yMGUxMiJ9.ruZUCY7P0KzZYhzDU_aQRg'
        }).addTo(localmap);

        let local_geojson = L.geoJson({
            "type": "FeatureCollection",
            "features": []
            }, {}
        );
        local_geojson.addTo(localmap);


        let picker = document.getElementById('borough-picker');
        for(var i = 0; i < greater_london.length; i++){

            var borough = greater_london[i];
            if(borough=="Hackney and City of London"){
                borough = "Hackney"
            }
            // create new option element
            var opt = document.createElement('option');
            opt.appendChild(document.createTextNode(borough));
            opt.value = borough; 
            picker.appendChild(opt); 
        }
        picker.addEventListener('change', (event) => {
            updateLocalMap(event.target.value)
        });
        picker.selectedIndex = 17;
        updateLocalMap(picker.value);

        setInterval(()=>{
            updateLocalMap(picker.value);
        }, 3000);


        function getBoroughGeoJSON(borough_name){
            var borough_geojson = null;
            for(var i = 0; i < counties.features.length; i++){
                if(counties.features[i].properties.ctyua15nm == borough_name){
                    borough_geojson = counties.features[i];
                    break;
                }
            }
            return borough_geojson;
        }


        function updateLocalMap(borough){
            
            borough_geojson = getBoroughGeoJSON(borough);
            if(borough_geojson != null){
                bbox = turf.bbox(borough_geojson);
                let cases = cases_archive[today][borough];
                if(cases===undefined){
                    cases = cases_archive[today][places[borough]];
                }
                let points = generatePointsInBorough(cases, borough);
                
                local_geojson.clearLayers();
                local_geojson.addData(points);

                document.getElementById('borough_name').innerHTML = borough;
                document.getElementById('borough_total').innerHTML = cases;
                

                localmap.fitBounds([
                    [bbox[1],bbox[0]],
                    [bbox[3],bbox[2]]
                ])
            }
        }

        function generatePointsInBorough(n, borough_name){
            let borough_geojson = getBoroughGeoJSON(borough_name);
            var bbox = turf.bbox(borough_geojson);
            var points = [];
            while(points.length < n){
                var point = turf.randomPoint(1, {bbox: bbox});
                if(turf.booleanPointInPolygon(point.features[0], borough_geojson)){
                    points.push(point.features[0]);
                }
            }
            return turf.featureCollection(points);
        }

        generatePointsInBorough(20, "Hackney");




        </script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-1627868-36"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-1627868-36');
</script>

        
</body>
</html>